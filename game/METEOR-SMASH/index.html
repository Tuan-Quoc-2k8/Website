<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meteor Smash</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial Black', sans-serif;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        #gameContainer {
            position: relative;
            width: 720px;
            height: 1280px;
            background: #000;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.3);
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #touchLayer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            display: none;
        }

        #touchLayer.active {
            display: block;
        }

        .hud-element {
            position: absolute;
            z-index: 5;
            pointer-events: none;
        }

        #hearts {
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
        }

        .heart {
            width: 40px;
            height: 40px;
            background: #ff0066;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            filter: drop-shadow(0 0 10px #ff0066);
            animation: heartbeat 1.5s infinite;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        #levelHud {
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }

        .level-text {
            color: #00ffff;
            font-size: 20px;
            text-shadow: 0 0 10px #00ffff;
            margin-bottom: 5px;
        }

        .xp-bar {
            width: 250px;
            height: 15px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #00ff00;
            border-radius: 10px;
            overflow: hidden;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #7fff00);
            width: 0%;
            transition: width 0.3s;
            box-shadow: 0 0 15px #00ff00;
        }

        #currency {
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .currency-display {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff00;
            border-radius: 20px;
            padding: 8px 15px;
            color: #fff;
            font-size: 16px;
            filter: drop-shadow(0 0 8px #00ff00);
        }

        .game-button {
            position: absolute;
            padding: 15px 30px;
            background: linear-gradient(135deg, #00ff00, #00cc00);
            border: 3px solid #00ff00;
            border-radius: 50px;
            color: #000;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            filter: drop-shadow(0 0 20px #00ff00);
            transition: all 0.2s;
            z-index: 20;
            pointer-events: auto;
        }

        .game-button:hover {
            transform: scale(1.1);
            filter: drop-shadow(0 0 30px #00ff00);
        }

        #pauseBtn {
            top: 130px;
            right: 20px;
            width: 60px;
            height: 60px;
            padding: 0;
            border-radius: 50%;
            font-size: 28px;
            display: none;
        }

        #pauseBtn.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #pauseMenu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            z-index: 100;
        }

        #pauseMenu.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .pause-title {
            font-size: 64px;
            color: #00ff00;
            text-shadow: 0 0 30px #00ff00;
            margin-bottom: 60px;
            animation: pulse 2s infinite;
        }

        .pause-menu-button {
            padding: 20px 60px;
            margin: 15px;
            background: linear-gradient(135deg, #00ff00, #00cc00);
            border: 3px solid #00ff00;
            border-radius: 50px;
            color: #000;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            filter: drop-shadow(0 0 20px #00ff00);
            transition: all 0.2s;
        }

        .pause-menu-button:hover {
            transform: scale(1.1);
        }

        #loadingScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a1f 0%, #1a1a3e 50%, #0a0a1f 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        #loadingScreen.hidden {
            display: none;
        }

        .loading-title {
            font-size: 72px;
            color: #00ffff;
            text-shadow: 0 0 40px #00ffff;
            margin-bottom: 60px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .loading-bar {
            width: 400px;
            height: 25px;
            background: rgba(0, 0, 0, 0.5);
            border: 3px solid #00ff00;
            border-radius: 15px;
            overflow: hidden;
        }

        .loading-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #00ffff, #00ff00);
            width: 0%;
            animation: loadProgress 3s ease-in-out forwards;
        }

        @keyframes loadProgress {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        #mainMenu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a1f 0%, #1a1a3e 50%, #0a0a1f 100%);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        #mainMenu.active {
            display: flex;
        }

        .menu-title {
            font-size: 80px;
            color: #00ffff;
            text-shadow: 0 0 50px #00ffff;
            margin-bottom: 80px;
            animation: float 3s ease-in-out infinite;
        }

        .menu-button {
            padding: 20px 60px;
            margin: 15px;
            background: linear-gradient(135deg, #00ff00, #00cc00);
            border: 3px solid #00ff00;
            border-radius: 50px;
            color: #000;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            filter: drop-shadow(0 0 25px #00ff00);
            transition: all 0.2s;
        }

        .menu-button:hover {
            transform: scale(1.1);
        }

        #skillScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 40px;
        }

        #skillScreen.active {
            display: flex;
        }

        .skill-title {
            font-size: 48px;
            color: #00ff00;
            text-shadow: 0 0 30px #00ff00;
            margin-bottom: 50px;
        }

        #skillsContainer {
            display: flex;
            gap: 30px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 40px;
        }

        .skill-card {
            width: 200px;
            background: linear-gradient(135deg, #1a1a3e 0%, #2a2a4e 100%);
            border: 3px solid #00ffff;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .skill-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 0 40px rgba(0, 255, 255, 0.6);
        }

        .skill-card.selected {
            border-color: #00ff00;
            background: linear-gradient(135deg, #2a4a2a 0%, #3a5a3a 100%);
            transform: translateY(-10px) scale(1.05);
        }

        .skill-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .skill-name {
            font-size: 20px;
            color: #00ffff;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .skill-description {
            font-size: 14px;
            color: #aaa;
            line-height: 1.4;
        }

        #confirmSkill {
            padding: 20px 50px;
            background: linear-gradient(135deg, #00ff00, #00cc00);
            border: 3px solid #00ff00;
            border-radius: 50px;
            color: #000;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            filter: drop-shadow(0 0 20px #00ff00);
        }

        #confirmSkill:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #gameOverScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        #gameOverScreen.active {
            display: flex;
        }

        .game-over-title {
            font-size: 72px;
            color: #ff0066;
            text-shadow: 0 0 40px #ff0066;
            margin-bottom: 40px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .final-score {
            font-size: 36px;
            color: #00ffff;
            margin-bottom: 60px;
        }

        .game-over-button {
            padding: 20px 50px;
            margin: 15px;
            background: linear-gradient(135deg, #00ff00, #00cc00);
            border: 3px solid #00ff00;
            border-radius: 50px;
            color: #000;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }

        .game-over-button:hover {
            transform: scale(1.1);
        }

        #helpScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            z-index: 150;
            overflow-y: auto;
        }

        #helpScreen.active {
            display: block;
        }

        .help-container {
            max-width: 600px;
            margin: 40px auto;
            padding: 30px;
        }

        .help-header {
            font-size: 48px;
            color: #00ff00;
            text-align: center;
            margin-bottom: 40px;
        }

        .help-section {
            background: rgba(26, 26, 62, 0.8);
            border: 2px solid #00ffff;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .help-section-title {
            font-size: 28px;
            color: #00ffff;
            margin-bottom: 20px;
        }

        .help-text {
            font-size: 16px;
            color: #ccc;
            line-height: 1.8;
            margin-bottom: 10px;
        }

        .close-help-btn {
            display: block;
            margin: 30px auto;
            padding: 15px 40px;
            background: linear-gradient(135deg, #00ff00, #00cc00);
            border: 3px solid #00ff00;
            border-radius: 50px;
            color: #000;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="720" height="1280"></canvas>
        <canvas id="touchLayer"></canvas>
        
        <div id="hearts" class="hud-element"></div>
        
        <div id="levelHud" class="hud-element">
            <div class="level-text">Level <span id="levelNum">1</span></div>
            <div class="xp-bar">
                <div class="xp-fill" id="xpFill"></div>
            </div>
        </div>
        
        <div id="currency" class="hud-element">
            <div class="currency-display">‚≠ê <span id="scoreDisplay">0</span></div>
            <div class="currency-display">üí∞ <span id="coinDisplay">0</span></div>
        </div>
        
        <button id="pauseBtn" class="game-button" onclick="game.togglePause()">‚è∏</button>
        
        <div id="loadingScreen">
            <div class="loading-title">METEOR SMASH</div>
            <div class="loading-bar">
                <div class="loading-fill"></div>
            </div>
        </div>
        
        <div id="mainMenu">
            <div class="menu-title">METEOR SMASH</div>
            <button class="menu-button" onclick="game.startGame()">‚ñ∂ PLAY</button>
            <button class="menu-button" onclick="game.showHelp()">‚ùì HOW TO PLAY</button>
        </div>
        
        <div id="pauseMenu">
            <div class="pause-title">‚è∏ PAUSED</div>
            <button class="pause-menu-button" onclick="game.resumeGame()">‚ñ∂ RESUME</button>
            <button class="pause-menu-button" onclick="game.returnToMainMenu()">üè† MAIN MENU</button>
        </div>
        
        <div id="skillScreen">
            <div class="skill-title">‚¨ÜÔ∏è LEVEL UP! Choose an Upgrade:</div>
            <div id="skillsContainer"></div>
            <button id="confirmSkill" onclick="game.confirmSkill()" disabled>‚úÖ CONFIRM</button>
        </div>
        
        <div id="gameOverScreen">
            <div class="game-over-title">üíÄ GAME OVER</div>
            <div class="final-score">Final Score: <span id="finalScore">0</span></div>
            <button class="game-over-button" onclick="game.restart()">üîÑ PLAY AGAIN</button>
            <button class="game-over-button" onclick="game.backToMenu()">üè† MAIN MENU</button>
        </div>
        
        <div id="helpScreen">
            <div class="help-container">
                <div class="help-header">üìñ HOW TO PLAY</div>
                
                <div class="help-section">
                    <div class="help-section-title">üéÆ Controls</div>
                    <p class="help-text">Desktop: Use WASD or Arrow Keys to move</p>
                    <p class="help-text">Mobile: Touch and drag to move</p>
                    <p class="help-text">Your ship fires automatically!</p>
                </div>

                <div class="help-section">
                    <div class="help-section-title">üéØ Skills</div>
                    <p class="help-text">üî´ Support Fighters - Summon fighters to assist</p>
                    <p class="help-text">üí• Explosive Rounds - Bullets explode on impact</p>
                    <p class="help-text">‚ö° Chain Lightning - Periodic lightning chains</p>
                    <p class="help-text">üöÄ Homing Missiles - Heat-seeking missiles</p>
                    <p class="help-text">üîÑ Ricochet Bullets - Bullets bounce off targets</p>
                    <p class="help-text">üéØ Piercing Bullets - Penetrate multiple enemies</p>
                    <p class="help-text">üî¥ Laser Fortress - Continuous laser support</p>
                </div>
            </div>
            <button class="close-help-btn" onclick="game.closeHelp()">‚úÖ GOT IT!</button>
        </div>
    </div>

    <script>
        const SKILLS = {
            support_fighters: {
                id: 'support_fighters',
                name: 'Extra Firepower',
                icon: 'üî´',
                description: 'Support Fighters',
                maxTier: 2,
                conflicts: []
            },
            explosive_bullets: {
                id: 'explosive_bullets',
                name: 'Explosive Rounds',
                icon: 'üí•',
                description: 'Bullets explode on impact',
                maxTier: 2,
                conflicts: []
            },
            chain_lightning: {
                id: 'chain_lightning',
                name: 'Chain Lightning',
                icon: '‚ö°',
                description: 'Periodic lightning chains',
                maxTier: 2,
                conflicts: []
            },
            homing_missiles: {
                id: 'homing_missiles',
                name: 'Homing Missiles',
                icon: 'üöÄ',
                description: 'Heat-seeking missiles',
                maxTier: 2,
                conflicts: []
            },
            ricochet_bullets: {
                id: 'ricochet_bullets',
                name: 'Ricochet Bullets',
                icon: 'üîÅ',
                description: 'Bullets bounce off targets',
                maxTier: 2,
                conflicts: ['piercing_bullets']
            },
            piercing_bullets: {
                id: 'piercing_bullets',
                name: 'Piercing Bullets',
                icon: 'üéØ',
                description: 'Penetrate multiple enemies',
                maxTier: 2,
                conflicts: ['ricochet_bullets']
            },
            laser_fortress: {
                id: 'laser_fortress',
                name: 'Laser Fortress',
                icon: 'üî¥',
                description: 'Continuous laser support',
                maxTier: 2,
                conflicts: []
            }
        };

        const game = {
            canvas: null,
            ctx: null,
            starLayers: [],

            state: {
                running: false,
                paused: false,
                score: 0,
                coins: 0,
                selectedSkill: null,
                gameTime: 0
            },

            player: {
                x: 360,
                y: 1100,
                width: 40,
                height: 60,
                speed: 8,
                hearts: 3,
                level: 1,
                xp: 0,
                xpToNext: 100,
                damage: 20,
                attackSpeed: 3,
                skills: {},
                lastShot: 0
            },

            bullets: [],
            asteroids: [],
            keys: {},
            supportFighters: [],
            explosions: [],
            lightningBolts: [],
            missiles: [],
            laserShips: [],
            lastLightning: 0,
            lastMissile: 0,
            lastLaserActivation: 0,

            init() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.initStarLayers();
                this.setupEventListeners();
                this.simulateLoading();
            },

            initStarLayers() {
                this.starLayers = [
                    { stars: [], speed: 0.2, size: 1, count: 50, opacity: 0.4 },
                    { stars: [], speed: 0.5, size: 2, count: 80, opacity: 0.6 },
                    { stars: [], speed: 1.0, size: 3, count: 100, opacity: 0.9 }
                ];

                this.starLayers.forEach(layer => {
                    for (let i = 0; i < layer.count; i++) {
                        layer.stars.push({
                            x: Math.random() * 720,
                            y: Math.random() * 1280
                        });
                    }
                });
            },

            setupEventListeners() {
                window.addEventListener('keydown', (e) => {
                    this.keys[e.key] = true;
                });

                window.addEventListener('keyup', (e) => {
                    this.keys[e.key] = false;
                });

                const touchLayer = document.getElementById('touchLayer');
                touchLayer.width = 720;
                touchLayer.height = 1280;

                touchLayer.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                });

                touchLayer.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (this.state.running && !this.state.paused) {
                        const rect = touchLayer.getBoundingClientRect();
                        const touchX = e.touches[0].clientX - rect.left;
                        const touchY = e.touches[0].clientY - rect.top;
                        
                        this.player.x = Math.max(30, Math.min(690, (touchX / rect.width) * 720));
                        this.player.y = Math.max(30, Math.min(1250, (touchY / rect.height) * 1280));
                    }
                });
            },

            simulateLoading() {
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                    this.showMainMenu();
                }, 3000);
            },

            showMainMenu() {
                document.getElementById('mainMenu').classList.add('active');
            },

            startGame() {
                document.getElementById('mainMenu').classList.remove('active');
                
                this.state = {
                    running: true,
                    paused: false,
                    score: 0,
                    coins: 0,
                    selectedSkill: null,
                    gameTime: 0
                };

                this.player = {
                    x: 360,
                    y: 1100,
                    width: 40,
                    height: 60,
                    speed: 8,
                    hearts: 3,
                    level: 1,
                    xp: 0,
                    xpToNext: 100,
                    damage: 20,
                    attackSpeed: 3,
                    skills: {},
                    lastShot: 0
                };

                this.bullets = [];
                this.asteroids = [];
                this.supportFighters = [];
                this.explosions = [];
                this.lightningBolts = [];
                this.missiles = [];
                this.laserShips = [];
                this.lastLightning = 0;
                this.lastMissile = 0;
                this.lastLaserActivation = 0;

                this.updateHUD();
                document.getElementById('touchLayer').classList.add('active');
                document.getElementById('pauseBtn').classList.add('active');
                this.gameLoop();
            },

            togglePause() {
                this.state.paused = !this.state.paused;
                const pauseMenu = document.getElementById('pauseMenu');
                if (this.state.paused) {
                    pauseMenu.classList.add('active');
                } else {
                    pauseMenu.classList.remove('active');
                }
            },

            resumeGame() {
                this.state.paused = false;
                document.getElementById('pauseMenu').classList.remove('active');
            },

            returnToMainMenu() {
                this.state.paused = false;
                this.state.running = false;
                document.getElementById('pauseMenu').classList.remove('active');
                document.getElementById('touchLayer').classList.remove('active');
                document.getElementById('pauseBtn').classList.remove('active');
                this.showMainMenu();
            },

            showHelp() {
                document.getElementById('helpScreen').classList.add('active');
            },

            closeHelp() {
                document.getElementById('helpScreen').classList.remove('active');
            },

            updateHUD() {
                const heartsContainer = document.getElementById('hearts');
                heartsContainer.innerHTML = '';
                for (let i = 0; i < this.player.hearts; i++) {
                    const heart = document.createElement('div');
                    heart.className = 'heart';
                    heartsContainer.appendChild(heart);
                }

                document.getElementById('levelNum').textContent = this.player.level;
                const xpPercent = (this.player.xp / this.player.xpToNext) * 100;
                document.getElementById('xpFill').style.width = xpPercent + '%';

                document.getElementById('scoreDisplay').textContent = this.state.score;
                document.getElementById('coinDisplay').textContent = this.state.coins;
            },

            gainXP(amount) {
                this.player.xp += amount;
                if (this.player.xp >= this.player.xpToNext) {
                    this.levelUp();
                }
                this.updateHUD();
            },

            levelUp() {
                this.player.level++;
                this.player.xp = 0;
                this.player.xpToNext = Math.floor(this.player.xpToNext * 1.5);
                this.state.paused = true;
                this.showSkillSelection();
            },

            showSkillSelection() {
                const container = document.getElementById('skillsContainer');
                container.innerHTML = '';

                const available = Object.values(SKILLS).filter(skill => {
                    const currentTier = this.player.skills[skill.id] || 0;
                    if (currentTier >= skill.maxTier) return false;
                    
                    for (let conflict of skill.conflicts) {
                        if (this.player.skills[conflict] > 0) return false;
                    }
                    return true;
                });

                const choices = [];
                const pool = [...available];
                while (choices.length < 3 && pool.length > 0) {
                    const idx = Math.floor(Math.random() * pool.length);
                    choices.push(pool[idx]);
                    pool.splice(idx, 1);
                }

                choices.forEach(skill => {
                    const currentTier = this.player.skills[skill.id] || 0;
                    const nextTier = currentTier + 1;

                    const card = document.createElement('div');
                    card.className = 'skill-card';
                    card.innerHTML = `
                        <div class="skill-icon">${skill.icon}</div>
                        <div class="skill-name">${skill.name}</div>
                        <div class="skill-description">${skill.description}<br>Tier ${nextTier}/${skill.maxTier}</div>
                    `;
                    card.onclick = () => this.selectSkill(skill, nextTier, card);
                    container.appendChild(card);
                });

                document.getElementById('skillScreen').classList.add('active');
            },

            selectSkill(skill, tier, cardElement) {
                document.querySelectorAll('.skill-card').forEach(c => c.classList.remove('selected'));
                cardElement.classList.add('selected');
                this.state.selectedSkill = { id: skill.id, tier: tier };
                document.getElementById('confirmSkill').disabled = false;
            },

            confirmSkill() {
                if (!this.state.selectedSkill) return;

                const { id, tier } = this.state.selectedSkill;
                this.player.skills[id] = tier;

                // Initialize skill effects
                if (id === 'support_fighters') {
                    this.initSupportFighters(tier);
                }
                if (id === 'laser_fortress') {
                    this.initLaserShips(tier);
                }

                document.getElementById('skillScreen').classList.remove('active');
                this.state.paused = false;
                this.updateHUD();
            },

            initSupportFighters(tier) {
                this.supportFighters = [];
                this.supportFighters.push({
                    offsetX: -60,
                    offsetY: -20,
                    lastShot: 0
                });
                this.supportFighters.push({
                    offsetX: 60,
                    offsetY: -20,
                    lastShot: 0
                });
            },

            initLaserShips(tier) {
                this.laserShips = [];
                if (tier === 1) {
                    this.laserShips.push({
                        x: 30,
                        y: 400,
                        active: false,
                        activationTime: 0
                    });
                } else {
                    this.laserShips.push({
                        x: 690,
                        y: 300,
                        active: false,
                        activationTime: 0
                    });
                    this.laserShips.push({
                        x: 690,
                        y: 500,
                        active: false,
                        activationTime: 0
                    });
                }
            },

            gameLoop() {
                if (!this.state.running) return;
                
                if (!this.state.paused) {
                    this.update();
                    this.state.gameTime += 1/60;
                }
                
                this.render();
                requestAnimationFrame(() => this.gameLoop());
            },

            update() {
                // Movement
                if (this.keys['ArrowLeft'] || this.keys['a']) this.player.x -= this.player.speed;
                if (this.keys['ArrowRight'] || this.keys['d']) this.player.x += this.player.speed;
                if (this.keys['ArrowUp'] || this.keys['w']) this.player.y -= this.player.speed;
                if (this.keys['ArrowDown'] || this.keys['s']) this.player.y += this.player.speed;
                
                this.player.x = Math.max(30, Math.min(690, this.player.x));
                this.player.y = Math.max(30, Math.min(1250, this.player.y));

                // Shooting
                const now = Date.now();
                const tier = this.player.skills.support_fighters || 0;
                const mainShipFires = tier !== 1;

                if (mainShipFires && now - this.player.lastShot > 1000 / this.player.attackSpeed) {
                    this.shoot();
                    this.player.lastShot = now;
                }

                // Support fighters shoot
                if (tier > 0) {
                    this.supportFighters.forEach(fighter => {
                        if (now - fighter.lastShot > 1000 / 8) {
                            const dmg = tier === 2 ? this.player.damage * 1.5 : this.player.damage;
                            this.bullets.push({
                                x: this.player.x + fighter.offsetX,
                                y: this.player.y + fighter.offsetY,
                                width: 6,
                                height: 16,
                                damage: dmg,
                                fromFighter: true
                            });
                            fighter.lastShot = now;
                        }
                    });
                }

                // Chain Lightning
                const lightningTier = this.player.skills.chain_lightning || 0;
                if (lightningTier > 0) {
                    const cooldown = lightningTier === 1 ? 8000 : 5000;
                    if (now - this.lastLightning > cooldown) {
                        this.activateChainLightning(lightningTier);
                        this.lastLightning = now;
                    }
                }

                // Homing Missiles
                const missileTier = this.player.skills.homing_missiles || 0;
                if (missileTier > 0) {
                    if (now - this.lastMissile > 3000) {
                        this.launchMissiles(missileTier);
                        this.lastMissile = now;
                    }
                }

                // Laser Fortress
                const laserTier = this.player.skills.laser_fortress || 0;
                if (laserTier > 0) {
                    const cooldown = laserTier === 1 ? 15000 : 10000;
                    const duration = 10000;

                    this.laserShips.forEach(ship => {
                        if (!ship.active && now - this.lastLaserActivation > cooldown) {
                            ship.active = true;
                            ship.activationTime = now;
                            this.lastLaserActivation = now;
                        }

                        if (ship.active && now - ship.activationTime > duration) {
                            ship.active = false;
                        }

                        if (ship.active) {
                            this.applyLaserDamage(ship, laserTier);
                        }
                    });
                }

                // Spawn asteroids
                const baseSpawnRate = 0.008;
                const maxSpawnRate = 0.025;
                const spawnRateIncrease = Math.min(this.state.gameTime / 120, 1);
                const currentSpawnRate = baseSpawnRate + (maxSpawnRate - baseSpawnRate) * spawnRateIncrease;
                
                if (Math.random() < currentSpawnRate) {
                    this.spawnAsteroid();
                }

                // Update bullets
                this.bullets = this.bullets.filter(b => {
                    b.y -= 15;
                    
                    if (b.ricochet && b.bounced) {
                        b.x += b.vx || 0;
                        b.y += b.vy || 0;
                    }
                    
                    return b.y > -20 && b.y < 1300 && b.x > 0 && b.x < 720;
                });

                // Update missiles
                this.missiles.forEach(missile => {
                    if (missile.target && this.asteroids.includes(missile.target)) {
                        const dx = missile.target.x - missile.x;
                        const dy = missile.target.y - missile.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        
                        missile.vx += (dx / dist) * 0.3;
                        missile.vy += (dy / dist) * 0.3;
                        
                        const speed = Math.sqrt(missile.vx * missile.vx + missile.vy * missile.vy);
                        if (speed > 6) {
                            missile.vx = (missile.vx / speed) * 6;
                            missile.vy = (missile.vy / speed) * 6;
                        }
                    }
                    
                    missile.x += missile.vx;
                    missile.y += missile.vy;
                });

                // Update asteroids
                this.asteroids.forEach((a, i) => {
                    if (a.knockbackTime !== undefined) {
                        a.knockbackTime--;
                        if (a.knockbackTime <= 0) {
                            delete a.knockbackTime;
                            delete a.knockbackVx;
                            delete a.knockbackVy;
                        } else {
                            a.x += a.knockbackVx;
                            a.y += a.knockbackVy;
                        }
                    } else {
                        a.y += a.vy;
                        a.x += a.vx;
                    }
                    
                    a.rotation += a.rotSpeed;

                    if (a.x <= a.size/2 || a.x >= 720 - a.size/2) a.vx *= -1;

                    if (this.checkCollision(this.player, a)) {
                        this.player.hearts--;
                        this.updateHUD();
                        this.asteroids.splice(i, 1);
                        if (this.player.hearts <= 0) this.gameOver();
                    }

                    if (a.y > 1300) this.asteroids.splice(i, 1);
                });

                // Bullet-asteroid collisions
                this.bullets.forEach((b, bi) => {
                    let hitCount = 0;
                    const pierceTier = this.player.skills.piercing_bullets || 0;
                    const maxPierce = pierceTier === 1 ? 2 : (pierceTier === 2 ? 4 : 1);
                    
                    this.asteroids.forEach((a, ai) => {
                        if (this.checkCollision(b, a) && hitCount < maxPierce) {
                            const dmg = b.damage || this.player.damage;
                            const finalDmg = pierceTier === 2 && hitCount === 0 ? dmg * 2 : dmg;
                            
                            a.hp -= finalDmg;
                            hitCount++;
                            
                            // Explosive bullets
                            const explosiveTier = this.player.skills.explosive_bullets || 0;
                            if (explosiveTier > 0) {
                                this.createExplosion(b.x, b.y, explosiveTier);
                            }
                            
                            // Ricochet bullets
                            const ricochetTier = this.player.skills.ricochet_bullets || 0;
                            if (ricochetTier > 0 && !b.bounced) {
                                if (ricochetTier === 1) {
                                    b.bounced = true;
                                    const angle = Math.random() * Math.PI * 2;
                                    b.vx = Math.cos(angle) * 10;
                                    b.vy = Math.sin(angle) * 10;
                                    b.ricochet = true;
                                } else {
                                    for (let i = 0; i < 2; i++) {
                                        const angle = Math.random() * Math.PI * 2;
                                        this.bullets.push({
                                            x: b.x,
                                            y: b.y,
                                            width: 6,
                                            height: 16,
                                            damage: dmg,
                                            vx: Math.cos(angle) * 8,
                                            vy: Math.sin(angle) * 8,
                                            bounced: true,
                                            ricochet: true
                                        });
                                    }
                                }
                            }
                            
                            if (a.hp <= 0) {
                                this.destroyAsteroid(a, ai);
                                this.gainXP(10);
                                this.state.score += 10;
                                this.state.coins += 1;
                                this.updateHUD();
                            }
                            
                            if (pierceTier === 0 && ricochetTier === 0) {
                                this.bullets.splice(bi, 1);
                            }
                        }
                    });
                });

                // Missile-asteroid collisions
                this.missiles.forEach((m, mi) => {
                    this.asteroids.forEach((a, ai) => {
                        if (this.checkCollision(m, a)) {
                            a.hp -= this.player.damage * 1.5;
                            
                            if (a.hp <= 0) {
                                this.destroyAsteroid(a, ai);
                                this.gainXP(10);
                                this.state.score += 10;
                                this.state.coins += 1;
                                this.updateHUD();
                            }
                            
                            this.missiles.splice(mi, 1);
                        }
                    });
                });

                // Update explosions
                this.explosions = this.explosions.filter(exp => {
                    exp.time += 16;
                    return exp.time < exp.duration;
                });

                // Update lightning bolts
                this.lightningBolts = this.lightningBolts.filter(bolt => {
                    bolt.time += 16;
                    return bolt.time < bolt.duration;
                });
            },

            activateChainLightning(tier) {
                const chainCount = tier === 1 ? 3 : 5;
                const damage = tier === 1 ? this.player.damage * 1.5 : this.player.damage * 1.75;
                const color = tier === 1 ? '#00ffff' : '#ff0066';
                
                let targets = [...this.asteroids].sort((a, b) => {
                    const distA = Math.sqrt((a.x - this.player.x) ** 2 + (a.y - this.player.y) ** 2);
                    const distB = Math.sqrt((b.x - this.player.x) ** 2 + (b.y - this.player.y) ** 2);
                    return distA - distB;
                }).slice(0, chainCount);

                let prev = { x: this.player.x, y: this.player.y };
                targets.forEach(target => {
                    this.lightningBolts.push({
                        x1: prev.x,
                        y1: prev.y,
                        x2: target.x,
                        y2: target.y,
                        color: color,
                        time: 0,
                        duration: 500
                    });
                    
                    target.hp -= damage;
                    if (target.hp <= 0) {
                        const idx = this.asteroids.indexOf(target);
                        if (idx !== -1) {
                            this.destroyAsteroid(target, idx);
                            this.gainXP(10);
                            this.state.score += 10;
                            this.state.coins += 1;
                            this.updateHUD();
                        }
                    }
                    
                    prev = target;
                });
            },

            launchMissiles(tier) {
                const count = tier === 1 ? 1 : 3;
                const targets = [...this.asteroids].sort((a, b) => {
                    const distA = Math.sqrt((a.x - this.player.x) ** 2 + (a.y - this.player.y) ** 2);
                    const distB = Math.sqrt((b.x - this.player.x) ** 2 + (b.y - this.player.y) ** 2);
                    return distA - distB;
                }).slice(0, count);

                targets.forEach(target => {
                    this.missiles.push({
                        x: this.player.x,
                        y: this.player.y - 30,
                        vx: 0,
                        vy: -3,
                        target: target,
                        size: 8
                    });
                });
            },

            applyLaserDamage(ship, tier) {
                const damage = tier === 1 ? 5 : 7.5;
                
                this.asteroids.forEach((a, idx) => {
                    const dx = a.x - ship.x;
                    const dy = a.y - ship.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    if (dist < 800) {
                        const blocked = this.isLaserBlocked(ship.x, ship.y, a.x, a.y, a);
                        
                        if (!blocked && Math.random() < 0.05) {
                            a.hp -= damage;
                            
                            if (a.hp <= 0) {
                                this.destroyAsteroid(a, idx);
                                this.gainXP(10);
                                this.state.score += 10;
                                this.state.coins += 1;
                                this.updateHUD();
                            }
                        }
                    }
                });
            },

            isLaserBlocked(x1, y1, x2, y2, targetAsteroid) {
                for (let asteroid of this.asteroids) {
                    if (asteroid === targetAsteroid) continue;
                    
                    const dist = this.pointToLineDistance(asteroid.x, asteroid.y, x1, y1, x2, y2);
                    if (dist < asteroid.size / 2) {
                        const d1 = Math.sqrt((asteroid.x - x1) ** 2 + (asteroid.y - y1) ** 2);
                        const d2 = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
                        if (d1 < d2) return true;
                    }
                }
                return false;
            },

            pointToLineDistance(px, py, x1, y1, x2, y2) {
                const A = px - x1;
                const B = py - y1;
                const C = x2 - x1;
                const D = y2 - y1;
                const dot = A * C + B * D;
                const lenSq = C * C + D * D;
                const param = lenSq !== 0 ? dot / lenSq : -1;
                
                let xx, yy;
                if (param < 0) {
                    xx = x1;
                    yy = y1;
                } else if (param > 1) {
                    xx = x2;
                    yy = y2;
                } else {
                    xx = x1 + param * C;
                    yy = y1 + param * D;
                }
                
                const dx = px - xx;
                const dy = py - yy;
                return Math.sqrt(dx * dx + dy * dy);
            },

            createExplosion(x, y, tier) {
                const radius = tier === 1 ? 50 : 80;
                const damage = tier === 1 ? this.player.damage : this.player.damage * 2;
                
                this.explosions.push({
                    x: x,
                    y: y,
                    radius: radius,
                    maxRadius: tier === 1 ? 60 : 100,
                    time: 0,
                    duration: tier === 1 ? 300 : 400
                });
                
                this.asteroids.forEach((a, idx) => {
                    const dist = Math.sqrt((a.x - x) ** 2 + (a.y - y) ** 2);
                    if (dist < radius) {
                        a.hp -= damage;
                        
                        if (a.hp <= 0) {
                            this.destroyAsteroid(a, idx);
                            this.gainXP(10);
                            this.state.score += 10;
                            this.state.coins += 1;
                            this.updateHUD();
                        }
                    }
                });
            },

            destroyAsteroid(asteroid, index) {
                this.asteroids.splice(index, 1);

                if (asteroid.tier !== 'small') {
                    const nextTier = this.getNextTier(asteroid.tier);
                    const nextSize = this.getSizeForTier(nextTier);
                    const nextHP = this.getHPForTier(nextTier);

                    for (let i = 0; i < 2; i++) {
                        const horizontalDirection = (i === 0 ? -1 : 1);
                        const horizontalSpeed = 2 + Math.random() * 1.5;
                        const baseDownwardVelocity = Math.max(asteroid.vy, 1.5);
                        const downwardSpeed = baseDownwardVelocity + Math.random() * 0.5;

                        this.asteroids.push({
                            x: asteroid.x + horizontalDirection * 20,
                            y: asteroid.y,
                            size: nextSize,
                            hp: nextHP,
                            tier: nextTier,
                            vx: horizontalDirection * horizontalSpeed,
                            vy: downwardSpeed,
                            rotation: Math.random() * Math.PI * 2,
                            rotSpeed: (Math.random() - 0.5) * 0.08,
                            color: asteroid.color,
                            vertices: this.generatePolygon(nextSize)
                        });
                    }
                }
            },

            getNextTier(currentTier) {
                const tiers = {
                    'veryLarge': 'large',
                    'large': 'medium',
                    'medium': 'small',
                    'small': null
                };
                return tiers[currentTier];
            },

            getSizeForTier(tier) {
                const sizes = {
                    'veryLarge': 120,
                    'large': 85,
                    'medium': 55,
                    'small': 30
                };
                return sizes[tier];
            },

            getHPForTier(tier) {
                const hps = {
                    'veryLarge': 80,
                    'large': 40,
                    'medium': 20,
                    'small': 10
                };
                return hps[tier];
            },

            shoot() {
                this.bullets.push({
                    x: this.player.x,
                    y: this.player.y - 30,
                    width: 8,
                    height: 20,
                    damage: this.player.damage
                });
            },

            spawnAsteroid() {
                const tierWeights = [
                    { tier: 'veryLarge', weight: 0.3 },
                    { tier: 'large', weight: 0.35 },
                    { tier: 'medium', weight: 0.25 },
                    { tier: 'small', weight: 0.1 }
                ];

                let rand = Math.random();
                let selectedTier = 'medium';
                let cumulative = 0;
                
                for (const tw of tierWeights) {
                    cumulative += tw.weight;
                    if (rand <= cumulative) {
                        selectedTier = tw.tier;
                        break;
                    }
                }

                const size = this.getSizeForTier(selectedTier);
                const hp = this.getHPForTier(selectedTier);
                const colors = ['#00ffff', '#ff00ff', '#00ff00', '#ff8800', '#8800ff', '#ffff00', '#ff0088', '#00ff88'];

                this.asteroids.push({
                    x: Math.random() * 720,
                    y: -100,
                    size: size,
                    hp: hp,
                    tier: selectedTier,
                    vx: (Math.random() - 0.5) * 2,
                    vy: 1 + Math.random() * 2,
                    rotation: 0,
                    rotSpeed: (Math.random() - 0.5) * 0.05,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    vertices: this.generatePolygon(size)
                });
            },

            generatePolygon(size) {
                const vertices = [];
                const count = 6 + Math.floor(Math.random() * 3);
                for (let i = 0; i < count; i++) {
                    const angle = (i / count) * Math.PI * 2;
                    const radius = size / 2 * (0.8 + Math.random() * 0.4);
                    vertices.push({
                        x: Math.cos(angle) * radius,
                        y: Math.sin(angle) * radius
                    });
                }
                return vertices;
            },

            checkCollision(a, b) {
                const r1 = a.width ? Math.max(a.width, a.height) / 2 : (a.size || 5);
                const r2 = b.width ? Math.max(b.width, b.height) / 2 : b.size / 2;
                const dist = Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2);
                return dist < r1 + r2;
            },

            render() {
                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(0, 0, 720, 1280);
                this.renderParallaxStars();

                // Render laser beams
                this.laserShips.forEach(ship => {
                    if (ship.active) {
                        this.ctx.strokeStyle = '#ff0000';
                        this.ctx.lineWidth = 15;
                        this.ctx.globalAlpha = 0.6;
                        this.ctx.shadowBlur = 20;
                        this.ctx.shadowColor = '#ff0000';
                        
                        this.asteroids.forEach(a => {
                            const blocked = this.isLaserBlocked(ship.x, ship.y, a.x, a.y, a);
                            if (!blocked) {
                                this.ctx.beginPath();
                                this.ctx.moveTo(ship.x, ship.y);
                                this.ctx.lineTo(a.x, a.y);
                                this.ctx.stroke();
                            }
                        });
                        
                        this.ctx.globalAlpha = 1;
                        this.ctx.shadowBlur = 0;
                        
                        // Draw laser ship
                        this.ctx.fillStyle = '#666';
                        this.ctx.fillRect(ship.x - 20, ship.y - 20, 40, 40);
                    }
                });

                // Render asteroids
                this.asteroids.forEach(a => {
                    this.ctx.save();
                    this.ctx.translate(a.x, a.y);
                    this.ctx.rotate(a.rotation);
                    this.ctx.beginPath();
                    a.vertices.forEach((v, i) => {
                        if (i === 0) this.ctx.moveTo(v.x, v.y);
                        else this.ctx.lineTo(v.x, v.y);
                    });
                    this.ctx.closePath();
                    this.ctx.fillStyle = a.color + '33';
                    this.ctx.fill();
                    this.ctx.strokeStyle = a.color;
                    this.ctx.lineWidth = 4;
                    this.ctx.shadowBlur = 20;
                    this.ctx.shadowColor = a.color;
                    this.ctx.stroke();
                    this.ctx.shadowBlur = 0;
                    this.ctx.restore();
                    this.ctx.fillStyle = '#fff';
                    this.ctx.font = `bold ${a.size * 0.3}px Arial`;
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillText(Math.ceil(a.hp), a.x, a.y);
                });

                // Render player
                this.ctx.save();
                this.ctx.translate(this.player.x, this.player.y);
                this.ctx.fillStyle = '#fff';
                this.ctx.shadowBlur = 15;
                this.ctx.shadowColor = '#00ffff';
                this.ctx.beginPath();
                this.ctx.moveTo(0, -30);
                this.ctx.lineTo(-20, 30);
                this.ctx.lineTo(0, 20);
                this.ctx.lineTo(20, 30);
                this.ctx.closePath();
                this.ctx.fill();
                this.ctx.shadowBlur = 0;
                this.ctx.restore();

                // Render support fighters
                this.supportFighters.forEach(fighter => {
                    const x = this.player.x + fighter.offsetX;
                    const y = this.player.y + fighter.offsetY;
                    this.ctx.save();
                    this.ctx.translate(x, y);
                    this.ctx.fillStyle = '#00ffff';
                    this.ctx.shadowBlur = 10;
                    this.ctx.shadowColor = '#00ffff';
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, -15);
                    this.ctx.lineTo(-10, 15);
                    this.ctx.lineTo(0, 10);
                    this.ctx.lineTo(10, 15);
                    this.ctx.closePath();
                    this.ctx.fill();
                    this.ctx.shadowBlur = 0;
                    this.ctx.restore();
                });

                // Render bullets
                this.bullets.forEach(b => {
                    this.ctx.fillStyle = b.fromFighter ? '#00ffff' : '#00ff00';
                    this.ctx.shadowBlur = 10;
                    this.ctx.shadowColor = b.fromFighter ? '#00ffff' : '#00ff00';
                    this.ctx.fillRect(b.x - 4, b.y - 10, 8, 20);
                    this.ctx.shadowBlur = 0;
                });

                // Render missiles
                this.missiles.forEach(m => {
                    this.ctx.fillStyle = '#ff9900';
                    this.ctx.shadowBlur = 15;
                    this.ctx.shadowColor = '#ff9900';
                    this.ctx.beginPath();
                    this.ctx.arc(m.x, m.y, m.size, 0, Math.PI * 2);
                    this.ctx.fill();
                    this.ctx.shadowBlur = 0;
                });

                // Render explosions
                this.explosions.forEach(exp => {
                    const progress = exp.time / exp.duration;
                    const currentRadius = exp.radius + (exp.maxRadius - exp.radius) * progress;
                    const alpha = 1 - progress;
                    
                    this.ctx.strokeStyle = `rgba(255, 102, 0, ${alpha})`;
                    this.ctx.lineWidth = 3;
                    this.ctx.shadowBlur = 20;
                    this.ctx.shadowColor = '#ff6600';
                    this.ctx.beginPath();
                    this.ctx.arc(exp.x, exp.y, currentRadius, 0, Math.PI * 2);
                    this.ctx.stroke();
                    this.ctx.shadowBlur = 0;
                });

                // Render lightning
                this.lightningBolts.forEach(bolt => {
                    const alpha = 1 - (bolt.time / bolt.duration);
                    this.ctx.strokeStyle = bolt.color;
                    this.ctx.lineWidth = 3;
                    this.ctx.globalAlpha = alpha;
                    this.ctx.shadowBlur = 15;
                    this.ctx.shadowColor = bolt.color;
                    this.ctx.beginPath();
                    this.ctx.moveTo(bolt.x1, bolt.y1);
                    this.ctx.lineTo(bolt.x2, bolt.y2);
                    this.ctx.stroke();
                    this.ctx.shadowBlur = 0;
                    this.ctx.globalAlpha = 1;
                });
            },

            renderParallaxStars() {
                this.starLayers.forEach(layer => {
                    this.ctx.fillStyle = `rgba(255, 255, 255, ${layer.opacity})`;
                    layer.stars.forEach(star => {
                        star.y += layer.speed;
                        if (star.y > 1280) {
                            star.y = 0;
                            star.x = Math.random() * 720;
                        }
                        this.ctx.fillRect(star.x, star.y, layer.size, layer.size);
                    });
                });
            },

            gameOver() {
                this.state.running = false;
                document.getElementById('touchLayer').classList.remove('active');
                document.getElementById('pauseBtn').classList.remove('active');
                document.getElementById('finalScore').textContent = this.state.score;
                document.getElementById('gameOverScreen').classList.add('active');
            },

            restart() {
                document.getElementById('gameOverScreen').classList.remove('active');
                this.startGame();
            },

            backToMenu() {
                document.getElementById('gameOverScreen').classList.remove('active');
                this.showMainMenu();
            }
        };

        game.init();
    </script>
</body>
</html>