<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Meteor Smash</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Arial Black', sans-serif;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            touch-action: none;
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            max-width: 720px;
            height: 100vh;
            max-height: 1280px;
            background: #000;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.3);
        }

        @media (min-width: 721px) {
            #gameContainer {
                width: 720px;
                height: 1280px;
            }
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #touchLayer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            display: none;
        }

        #touchLayer.active {
            display: block;
        }

        .hud-element {
            position: absolute;
            z-index: 5;
            pointer-events: none;
        }

        #hearts {
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
        }

        .heart {
            width: 40px;
            height: 40px;
            background: #ff0066;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            filter: drop-shadow(0 0 10px #ff0066);
            animation: heartbeat 1.5s infinite;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        #levelHud {
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }

        .level-text {
            color: #00ffff;
            font-size: 20px;
            text-shadow: 0 0 10px #00ffff;
            margin-bottom: 5px;
        }

        .xp-bar {
            width: 250px;
            height: 15px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #00ff00;
            border-radius: 10px;
            overflow: hidden;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #7fff00);
            width: 0%;
            transition: width 0.3s;
            box-shadow: 0 0 15px #00ff00;
        }

        #currency {
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .currency-display {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff00;
            border-radius: 20px;
            padding: 8px 15px;
            color: #fff;
            font-size: 16px;
            filter: drop-shadow(0 0 8px #00ff00);
        }

        .game-button {
            position: absolute;
            padding: 15px 30px;
            background: linear-gradient(135deg, #00ff00, #00cc00);
            border: 3px solid #00ff00;
            border-radius: 50px;
            color: #000;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            filter: drop-shadow(0 0 20px #00ff00);
            transition: all 0.2s;
            z-index: 20;
            pointer-events: auto;
        }

        .game-button:hover {
            transform: scale(1.1);
            filter: drop-shadow(0 0 30px #00ff00);
        }

        .game-button:active {
            transform: scale(0.95);
        }

        #pauseBtn {
            top: 130px;
            right: 20px;
            width: 60px;
            height: 60px;
            padding: 0;
            border-radius: 50%;
            font-size: 28px;
            display: none;
        }

        #pauseBtn.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #pauseMenu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        #pauseMenu.active {
            display: flex;
        }

        .pause-title {
            font-size: 64px;
            color: #00ff00;
            text-shadow: 0 0 30px #00ff00;
            margin-bottom: 60px;
            animation: pulse 2s infinite;
            text-align: center;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        .pause-menu-button {
            padding: 20px 60px;
            margin: 15px;
            background: linear-gradient(135deg, #00ff00, #00cc00);
            border: 3px solid #00ff00;
            border-radius: 50px;
            color: #000;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            filter: drop-shadow(0 0 20px #00ff00);
            transition: all 0.2s;
            pointer-events: auto;
        }

        .pause-menu-button:hover {
            transform: scale(1.1);
            filter: drop-shadow(0 0 30px #00ff00);
        }

        .pause-menu-button:active {
            transform: scale(0.95);
        }

        .pause-menu-button.secondary {
            background: linear-gradient(135deg, #ff00ff, #cc00cc);
            border-color: #ff00ff;
            filter: drop-shadow(0 0 20px #ff00ff);
        }

        .pause-menu-button.secondary:hover {
            filter: drop-shadow(0 0 30px #ff00ff);
        }

        /* IMPROVED: Enhanced Loading Screen */
        #loadingScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a1f 0%, #1a1a3e 50%, #0a0a1f 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        #loadingScreen.hidden {
            display: none;
        }

        /* NEW: Animated orbits for loading */
        .loading-animation {
            width: 200px;
            height: 200px;
            position: relative;
            margin-bottom: 50px;
        }

        .orbit {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 3px solid transparent;
            border-top-color: #00ff00;
            border-radius: 50%;
            animation: spin 2s linear infinite;
        }

        .orbit:nth-child(2) {
            width: 70%;
            height: 70%;
            top: 15%;
            left: 15%;
            border-top-color: #00ffff;
            animation-duration: 1.5s;
            animation-direction: reverse;
        }

        .orbit:nth-child(3) {
            width: 40%;
            height: 40%;
            top: 30%;
            left: 30%;
            border-top-color: #ff00ff;
            animation-duration: 1s;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        .loading-core {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1); 
                opacity: 1;
                filter: drop-shadow(0 0 10px #00ff00);
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.2); 
                opacity: 0.8;
                filter: drop-shadow(0 0 30px #00ffff);
            }
        }

        .loading-title {
            font-size: 72px;
            color: #00ffff;
            text-shadow: 0 0 40px #00ffff;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
            text-align: center;
            font-weight: bold;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .loading-subtitle {
            font-size: 24px;
            color: #00ff00;
            text-shadow: 0 0 15px #00ff00;
            margin-bottom: 40px;
            animation: fade-in-out 2s ease-in-out infinite;
        }

        @keyframes fade-in-out {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .loading-bar {
            width: 400px;
            max-width: 80%;
            height: 25px;
            background: rgba(0, 0, 0, 0.5);
            border: 3px solid #00ff00;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }

        .loading-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #00ffff, #00ff00);
            background-size: 200% 100%;
            width: 0%;
            animation: loadProgress 3s ease-in-out forwards, shimmer 2s linear infinite;
            box-shadow: 0 0 20px #00ff00;
        }

        @keyframes loadProgress {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        #mainMenu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a1f 0%, #1a1a3e 50%, #0a0a1f 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        #mainMenu.hidden {
            display: none;
        }

        .menu-title {
            font-size: 96px;
            color: #00ff00;
            text-shadow: 0 0 40px #00ff00;
            margin-bottom: 80px;
            animation: pulse 2s infinite;
            text-align: center;
            line-height: 1.1;
        }

        .menu-button {
            padding: 20px 60px;
            margin: 15px;
            background: linear-gradient(135deg, #00ff00, #00cc00);
            border: 3px solid #00ff00;
            border-radius: 50px;
            color: #000;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            filter: drop-shadow(0 0 20px #00ff00);
            transition: all 0.2s;
        }

        .menu-button:hover {
            transform: scale(1.1);
            filter: drop-shadow(0 0 30px #00ff00);
        }

        .menu-button:active {
            transform: scale(0.95);
        }

        .menu-button.secondary {
            background: linear-gradient(135deg, #00ffff, #00cccc);
            border-color: #00ffff;
            filter: drop-shadow(0 0 20px #00ffff);
        }

        .menu-button.secondary:hover {
            filter: drop-shadow(0 0 30px #00ffff);
        }

        #skillScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            overflow-y: auto;
        }

        #skillScreen.active {
            display: flex;
        }

        .skill-title {
            font-size: 48px;
            color: #00ff00;
            text-shadow: 0 0 30px #00ff00;
            margin-bottom: 50px;
            text-align: center;
        }

        .skills-container {
            display: flex;
            flex-direction: row;
            gap: 20px;
            justify-content: center;
            align-items: stretch;
            padding: 0 30px;
            flex-wrap: wrap;
        }

        .skill-card {
            background: linear-gradient(135deg, rgba(10, 10, 31, 0.9), rgba(26, 26, 62, 0.9));
            border: 4px solid #00ff00;
            border-radius: 15px;
            padding: 25px 20px;
            width: 200px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0, 255, 0, 0.3);
        }

        .skill-card:hover {
            transform: translateY(-10px);
            border-color: #00ffff;
            box-shadow: 0 10px 40px rgba(0, 255, 255, 0.6);
        }

        .skill-card.selected {
            border-color: #ffff00;
            box-shadow: 0 10px 50px rgba(255, 255, 0, 0.8);
            transform: translateY(-15px) scale(1.05);
        }

        .skill-icon {
            font-size: 72px;
            margin-bottom: 15px;
            display: block;
        }

        .skill-name {
            font-size: 24px;
            color: #00ff00;
            margin-bottom: 12px;
            font-weight: bold;
        }

        .skill-description {
            font-size: 14px;
            color: #fff;
            line-height: 1.5;
        }

        .confirm-btn {
            margin-top: 50px;
            padding: 20px 60px;
            background: linear-gradient(135deg, #ffff00, #cccc00);
            border: 3px solid #ffff00;
            border-radius: 50px;
            color: #000;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            filter: drop-shadow(0 0 30px #ffff00);
            transition: all 0.2s;
        }

        .confirm-btn:hover {
            transform: scale(1.1);
        }

        .confirm-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #gameOverScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        #gameOverScreen.active {
            display: flex;
        }

        .gameover-title {
            font-size: 72px;
            color: #ff0066;
            text-shadow: 0 0 40px #ff0066;
            margin-bottom: 30px;
            animation: pulse 2s infinite;
            text-align: center;
        }

        .final-score {
            font-size: 48px;
            color: #00ff00;
            text-shadow: 0 0 30px #00ff00;
            margin-bottom: 50px;
            text-align: center;
        }

        .gameover-button {
            padding: 20px 60px;
            margin: 15px;
            background: linear-gradient(135deg, #00ff00, #00cc00);
            border: 3px solid #00ff00;
            border-radius: 50px;
            color: #000;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            filter: drop-shadow(0 0 20px #00ff00);
            transition: all 0.2s;
        }

        .gameover-button:hover {
            transform: scale(1.1);
            filter: drop-shadow(0 0 30px #00ff00);
        }

        .gameover-button.secondary {
            background: linear-gradient(135deg, #00ffff, #00cccc);
            border-color: #00ffff;
            filter: drop-shadow(0 0 20px #00ffff);
        }

        .gameover-button.secondary:hover {
            filter: drop-shadow(0 0 30px #00ffff);
        }

        #helpScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a1f 0%, #1a1a3e 50%, #0a0a1f 100%);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            z-index: 200;
            overflow-y: auto;
            padding: 40px 20px;
        }

        #helpScreen.active {
            display: flex;
        }

        .help-title {
            font-size: 56px;
            color: #00ff00;
            text-shadow: 0 0 30px #00ff00;
            margin-bottom: 40px;
            text-align: center;
        }

        .help-content {
            max-width: 600px;
            background: rgba(0, 0, 0, 0.7);
            border: 3px solid #00ffff;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .help-section {
            margin-bottom: 30px;
        }

        .help-section-title {
            font-size: 28px;
            color: #00ffff;
            text-shadow: 0 0 15px #00ffff;
            margin-bottom: 15px;
            border-bottom: 2px solid #00ffff;
            padding-bottom: 10px;
        }

        .help-text {
            font-size: 18px;
            color: #fff;
            line-height: 1.8;
            margin-bottom: 10px;
        }

        .help-highlight {
            color: #00ff00;
            font-weight: bold;
            text-shadow: 0 0 10px #00ff00;
        }

        .close-help-btn {
            padding: 20px 60px;
            background: linear-gradient(135deg, #00ff00, #00cc00);
            border: 3px solid #00ff00;
            border-radius: 50px;
            color: #000;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            filter: drop-shadow(0 0 20px #00ff00);
            transition: all 0.2s;
            margin-bottom: 40px;
        }

        .close-help-btn:hover {
            transform: scale(1.1);
            filter: drop-shadow(0 0 30px #00ff00);
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="touchLayer"></div>

        <div id="hearts" class="hud-element"></div>
        <div id="levelHud" class="hud-element">
            <div class="level-text">Level <span id="levelNum">1</span></div>
            <div class="xp-bar">
                <div class="xp-fill" id="xpFill"></div>
            </div>
        </div>
        <div id="currency" class="hud-element">
            <div class="currency-display">‚≠ê <span id="scoreDisplay">0</span></div>
            <div class="currency-display">üí∞ <span id="coinDisplay">0</span></div>
        </div>

        <button id="pauseBtn" class="game-button">‚è∏Ô∏è</button>

        <div id="pauseMenu">
            <div class="pause-title">‚è∏Ô∏è PAUSED</div>
            <button class="pause-menu-button" onclick="game.resumeGame()">‚ñ∂Ô∏è Resume Game</button>
            <button class="pause-menu-button secondary" onclick="game.returnToMainMenu()">üè† Return to Menu</button>
        </div>

        <!-- IMPROVED: Enhanced Loading Screen -->
        <div id="loadingScreen">
            <div class="loading-animation">
                <div class="orbit"></div>
                <div class="orbit"></div>
                <div class="orbit"></div>
                <div class="loading-core">üöÄ</div>
            </div>
            <div class="loading-title">METEOR SMASH</div>
            <div class="loading-subtitle">Loading Epic Space Battle...</div>
            <div class="loading-bar">
                <div class="loading-fill"></div>
            </div>
        </div>
        
        <div id="mainMenu">
            <div class="menu-title">METEOR<br>SMASH</div>
            <button class="menu-button" onclick="game.startGame()">‚ñ∂ PLAY</button>
            <button class="menu-button secondary" onclick="game.showHelp()">‚ùì HOW TO PLAY</button>
        </div>

        <div id="skillScreen">
            <div class="skill-title">‚≠ê LEVEL UP! Choose Your Upgrade ‚≠ê</div>
            <div class="skills-container" id="skillsContainer"></div>
            <button class="confirm-btn" id="confirmSkill" onclick="game.confirmSkill()" disabled>
                ‚ú® CONFIRM SELECTION ‚ú®
            </button>
        </div>

        <div id="gameOverScreen">
            <div class="gameover-title">üíÄ GAME OVER üíÄ</div>
            <div class="final-score">Score: <span id="finalScore">0</span></div>
            <button class="gameover-button" onclick="game.restart()">üîÑ PLAY AGAIN</button>
            <button class="gameover-button secondary" onclick="game.backToMenu()">üè† MAIN MENU</button>
        </div>

        <div id="helpScreen">
            <div class="help-title">üéÆ HOW TO PLAY</div>
            
            <div class="help-content">
                <div class="help-section">
                    <div class="help-section-title">üïπÔ∏è Controls</div>
                    <p class="help-text">
                        <span class="help-highlight">Move:</span> Use WASD keys or Arrow keys on keyboard, or touch/drag on mobile devices
                    </p>
                    <p class="help-text">
                        <span class="help-highlight">Shoot:</span> Your ship fires automatically - just focus on dodging!
                    </p>
                    <p class="help-text">
                        <span class="help-highlight">Pause:</span> Press ESC key or tap the ‚è∏Ô∏è button
                    </p>
                </div>

                <div class="help-section">
                    <div class="help-section-title">üí• Asteroid Mechanics</div>
                    <p class="help-text">
                        Asteroids come in <span class="help-highlight">4 sizes:</span> Very Large, Large, Medium, and Small
                    </p>
                    <p class="help-text">
                        When destroyed, larger asteroids <span class="help-highlight">split into 2 smaller ones</span> that fly apart!
                    </p>
                    <p class="help-text">
                        The smallest asteroids are destroyed completely
                    </p>
                    <p class="help-text">
                        Each asteroid shows its remaining <span class="help-highlight">HP</span> in the center
                    </p>
                </div>

                <div class="help-section">
                    <div class="help-section-title">‚¨ÜÔ∏è Progression System</div>
                    <p class="help-text">
                        Destroy asteroids to earn <span class="help-highlight">XP</span> and level up
                    </p>
                    <p class="help-text">
                        Each level grants you a choice of <span class="help-highlight">powerful upgrades:</span>
                    </p>
                    <p class="help-text">
                        üî± <span class="help-highlight">Multi-Shot:</span> Fire 2-3 bullets at once
                    </p>
                    <p class="help-text">
                        ‚ö° <span class="help-highlight">Rapid Fire:</span> Shoot faster
                    </p>
                    <p class="help-text">
                        üí• <span class="help-highlight">Power Shot:</span> Deal more damage
                    </p>
                    <p class="help-text">
                        ‚ù§Ô∏è <span class="help-highlight">Extra Life:</span> Gain an additional heart
                    </p>
                    <p class="help-text">
                        üî¥ <span class="help-highlight">Laser Fortress:</span> Continuous laser support
                    </p>
                    <p class="help-text">
                        üöÅ <span class="help-highlight">Support Fighters:</span> AI wingmen that fight alongside you
                    </p>
                </div>

                <div class="help-section">
                    <div class="help-section-title">üíÄ Boss Battles</div>
                    <p class="help-text">
                        Every <span class="help-highlight">3 minutes</span>, a powerful boss appears!
                    </p>
                    <p class="help-text">
                        Bosses have unique attacks and massive HP
                    </p>
                    <p class="help-text">
                        Defeat them for <span class="help-highlight">huge rewards!</span>
                    </p>
                </div>

                <div class="help-section">
                    <div class="help-section-title">‚ö†Ô∏è Survival Tips</div>
                    <p class="help-text">
                        Avoid collisions with asteroids - each hit loses 1 heart ‚ù§Ô∏è
                    </p>
                    <p class="help-text">
                        Difficulty increases over time as more asteroids spawn
                    </p>
                    <p class="help-text">
                        Focus on destroying larger asteroids first to prevent chain splitting
                    </p>
                    <p class="help-text">
                        Keep moving! A stationary target is an easy target
                    </p>
                </div>
            </div>

            <button class="close-help-btn" onclick="game.closeHelp()">‚úÖ GOT IT!</button>
        </div>
    </div>
    <script>
        // NEW: Image configuration for UI elements (optional image URLs)
        const IMAGE_CONFIG = {
            player: './img/spacecraft.png', // Set to image URL to use custom player sprite
            supportFighter: './img/support-fighter.png', // Set to image URL for support fighters
            laserTurret1: null, // Level 1 laser turret
            laserTurret2: null, // Level 2 laser turrets
            boss1: null, // Flame Demon
            boss2: null, // Void Kraken
            boss3: null  // Cyber Skull
        };

        // NEW: Image preloader
        const IMAGES = {};
        function loadImage(key, url) {
            if (!url) return null;
            const img = new Image();
            img.src = url;
            IMAGES[key] = img;
            return img;
        }

        // Initialize images if URLs are provided
        Object.keys(IMAGE_CONFIG).forEach(key => {
            if (IMAGE_CONFIG[key]) {
                loadImage(key, IMAGE_CONFIG[key]);
            }
        });

        const BOSSES = {
            flame_demon: {
                id: 'flame_demon',
                name: 'FLAME DEMON',
                color: '#ff4400',
                hp: 2000,
                size: 80,
                imageKey: 'boss1', // Links to IMAGE_CONFIG.boss1
                movement: (boss, game, time) => {
                    boss.x = 360 + Math.sin(time / 1000) * 200;
                    boss.y = 200 + Math.sin(time / 2000) * 50;
                },
                skills: [
                    {
                        name: 'Fireball Rain',
                        cooldown: 3000,
                        execute: (boss, game) => {
                            for (let i = 0; i < 8; i++) {
                                game.bossProjectiles.push({
                                    x: boss.x + (Math.random() - 0.5) * 200,
                                    y: -50,
                                    vx: 0,
                                    vy: 3 + Math.random() * 2,
                                    size: 15,
                                    color: '#ff4400',
                                    damage: 1
                                });
                            }
                        }
                    },
                    {
                        name: 'Flame Wave',
                        cooldown: 5000,
                        execute: (boss, game) => {
                            for (let i = 0; i < 12; i++) {
                                const angle = (i / 12) * Math.PI * 2;
                                game.bossProjectiles.push({
                                    x: boss.x,
                                    y: boss.y,
                                    vx: Math.cos(angle) * 4,
                                    vy: Math.sin(angle) * 4,
                                    size: 12,
                                    color: '#ff6600',
                                    damage: 1
                                });
                            }
                        }
                    }
                ]
            },
            void_kraken: {
                id: 'void_kraken',
                name: 'VOID KRAKEN',
                color: '#8800ff',
                hp: 2500,
                size: 90,
                imageKey: 'boss2',
                movement: (boss, game, time) => {
                    boss.y = 200 + Math.sin(time / 1500) * 100;
                    boss.x = 360 + Math.cos(time / 2000) * 250;
                },
                skills: [
                    {
                        name: 'Void Missiles',
                        cooldown: 2500,
                        execute: (boss, game) => {
                            for (let i = 0; i < 3; i++) {
                                game.bossProjectiles.push({
                                    x: boss.x,
                                    y: boss.y,
                                    vx: 0,
                                    vy: 3,
                                    size: 18,
                                    color: '#aa00ff',
                                    damage: 1,
                                    homing: true,
                                    speed: 3
                                });
                            }
                        }
                    },
                    {
                        name: 'Expanding Ring',
                        cooldown: 6000,
                        execute: (boss, game) => {
                            game.bossProjectiles.push({
                                x: boss.x,
                                y: boss.y,
                                radius: 50,
                                maxRadius: 600,
                                expandSpeed: 5,
                                color: '#cc00ff',
                                damage: 1,
                                ring: true
                            });
                        }
                    }
                ]
            },
            cyber_skull: {
                id: 'cyber_skull',
                name: 'CYBER SKULL',
                color: '#00ffff',
                hp: 3000,
                size: 85,
                imageKey: 'boss3',
                movement: (boss, game, time) => {
                    boss.x = 360 + Math.cos(time / 1000) * 180;
                    boss.y = 150 + Math.abs(Math.sin(time / 2000)) * 100;
                },
                skills: [
                    {
                        name: 'Energy Burst',
                        cooldown: 2000,
                        execute: (boss, game) => {
                            const angle = Math.atan2(game.player.y - boss.y, game.player.x - boss.x);
                            for (let i = -1; i <= 1; i++) {
                                const a = angle + (i * 0.3);
                                game.bossProjectiles.push({
                                    x: boss.x,
                                    y: boss.y,
                                    vx: Math.cos(a) * 5,
                                    vy: Math.sin(a) * 5,
                                    size: 14,
                                    color: '#00ffff',
                                    damage: 1
                                });
                            }
                        }
                    },
                    {
                        name: 'Laser Sweep',
                        cooldown: 8000,
                        execute: (boss, game) => {
                            // Rotating laser beam
                            boss.laserSweep = {
                                active: true,
                                startTime: Date.now(),
                                duration: 4000,
                                angle: 0
                            };
                        }
                    }
                ]
            }
        };

        const game = {
            canvas: null,
            ctx: null,
            starLayers: [],
            state: {
                running: false,
                paused: false,
                score: 0,
                coins: 0,
                selectedSkill: null,
                gameTime: 0
            },
            player: {
                x: 360,
                y: 1100,
                width: 50,
                height: 50,
                speed: 8,
                hearts: 3,
                level: 1,
                xp: 0,
                xpToNext: 100,
                damage: 20,
                attackSpeed: 3,
                skills: {},
                lastShot: 0
            },
            bullets: [],
            asteroids: [],
            supportFighters: [],
            laserShips: [], // FIXED: Laser fortress turrets
            bossProjectiles: [],
            boss: null,
            lastBossSpawn: 0,
            lastMissile: 0,
            lastLaserActivation: 0, // FIXED: Track laser activation globally
            keys: {},
            skillData: {
                multishot: {
                    id: 'multishot',
                    name: 'Multi-Shot',
                    icon: 'üî±',
                    description: 'Fire 2-3 bullets at once',
                    maxTier: 2
                },
                rapid: {
                    id: 'rapid',
                    name: 'Rapid Fire',
                    icon: '‚ö°',
                    description: 'Increase attack speed',
                    maxTier: 3
                },
                power: {
                    id: 'power',
                    name: 'Power Shot',
                    icon: 'üí•',
                    description: 'Increase damage',
                    maxTier: 3
                },
                shield: {
                    id: 'shield',
                    name: 'Extra Life',
                    icon: '‚ù§Ô∏è',
                    description: 'Gain +1 heart',
                    maxTier: 2
                },
                support_fighters: {
                    id: 'support_fighters',
                    name: 'Support Fighters',
                    icon: 'üöÅ',
                    description: 'AI wingmen assist you',
                    maxTier: 1
                },
                laser_fortress: {
                    id: 'laser_fortress',
                    name: 'Laser Fortress',
                    icon: 'üî¥',
                    description: 'Continuous laser support',
                    maxTier: 2
                }
            },

            init() {
                console.log('üéÆ Initializing game...');
                this.canvas = document.getElementById('gameCanvas');
                const container = document.getElementById('gameContainer');
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
                this.ctx = this.canvas.getContext('2d');

                this.initStarLayers();
                this.setupEventListeners();
                this.simulateLoading();
            },

            initStarLayers() {
                this.starLayers = [
                    { stars: [], speed: 0.2, size: 1, count: 50, opacity: 0.4 },
                    { stars: [], speed: 0.5, size: 2, count: 80, opacity: 0.6 },
                    { stars: [], speed: 1.0, size: 3, count: 100, opacity: 0.9 }
                ];

                this.starLayers.forEach(layer => {
                    for (let i = 0; i < layer.count; i++) {
                        layer.stars.push({
                            x: Math.random() * this.canvas.width,
                            y: Math.random() * this.canvas.height
                        });
                    }
                });
            },

            simulateLoading() {
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                }, 3000);
            },

            setupEventListeners() {
                document.addEventListener('keydown', (e) => {
                    this.keys[e.key] = true;
                    if (e.key === 'Escape' && this.state.running && !document.getElementById('skillScreen').classList.contains('active')) {
                        this.togglePause();
                    }
                });
                document.addEventListener('keyup', (e) => this.keys[e.key] = false);

                const touchLayer = document.getElementById('touchLayer');
                const handleMove = (e) => {
                    if (!this.state.running || this.state.paused) return;
                    e.preventDefault();
                    const rect = this.canvas.getBoundingClientRect();
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    this.player.x = (clientX - rect.left) * (this.canvas.width / rect.width);
                    this.player.y = (clientY - rect.top) * (this.canvas.height / rect.height);
                    this.player.x = Math.max(30, Math.min(this.canvas.width - 30, this.player.x));
                    this.player.y = Math.max(30, Math.min(this.canvas.height - 30, this.player.y));
                };
                touchLayer.addEventListener('touchstart', handleMove);
                touchLayer.addEventListener('touchmove', handleMove);
                touchLayer.addEventListener('mousemove', handleMove);

                document.getElementById('pauseBtn').addEventListener('click', () => this.togglePause());
            },

            showMainMenu() {
                document.getElementById('mainMenu').classList.remove('hidden');
            },

            startGame() {
                console.log('üöÄ Starting game...');
                document.getElementById('mainMenu').classList.add('hidden');
                document.getElementById('helpScreen').classList.remove('active');
                
                this.state = {
                    running: true,
                    paused: false,
                    score: 0,
                    coins: 0,
                    selectedSkill: null,
                    gameTime: 0
                };

                this.player = {
                    x: this.canvas.width / 2,
                    y: this.canvas.height - 180,
                    width: 50,
                    height: 50,
                    speed: 8,
                    hearts: 3,
                    level: 1,
                    xp: 0,
                    xpToNext: 100,
                    damage: 20,
                    attackSpeed: 3,
                    skills: {},
                    lastShot: 0
                };

                this.bullets = [];
                this.asteroids = [];
                this.supportFighters = [];
                this.laserShips = [];
                this.bossProjectiles = [];
                this.boss = null;
                this.lastBossSpawn = 0;
                this.lastMissile = 0;
                this.lastLaserActivation = 0;
                this.keys = {};

                document.getElementById('touchLayer').classList.add('active');
                document.getElementById('pauseBtn').classList.add('active');
                
                this.updateHUD();
                this.gameLoop();
            },

            togglePause() {
                this.state.paused = !this.state.paused;
                const pauseMenu = document.getElementById('pauseMenu');
                if (this.state.paused) {
                    pauseMenu.classList.add('active');
                } else {
                    pauseMenu.classList.remove('active');
                }
            },

            resumeGame() {
                this.state.paused = false;
                document.getElementById('pauseMenu').classList.remove('active');
            },

            returnToMainMenu() {
                this.state.paused = false;
                this.state.running = false;
                document.getElementById('pauseMenu').classList.remove('active');
                document.getElementById('touchLayer').classList.remove('active');
                document.getElementById('pauseBtn').classList.remove('active');
                this.showMainMenu();
            },

            showHelp() {
                document.getElementById('helpScreen').classList.add('active');
            },

            closeHelp() {
                document.getElementById('helpScreen').classList.remove('active');
            },

            updateHUD() {
                const heartsContainer = document.getElementById('hearts');
                heartsContainer.innerHTML = '';
                for (let i = 0; i < this.player.hearts; i++) {
                    const heart = document.createElement('div');
                    heart.className = 'heart';
                    heartsContainer.appendChild(heart);
                }

                document.getElementById('levelNum').textContent = this.player.level;
                const xpPercent = (this.player.xp / this.player.xpToNext) * 100;
                document.getElementById('xpFill').style.width = xpPercent + '%';

                document.getElementById('scoreDisplay').textContent = this.state.score;
                document.getElementById('coinDisplay').textContent = this.state.coins;
            },

            gainXP(amount) {
                this.player.xp += amount;
                if (this.player.xp >= this.player.xpToNext) {
                    this.levelUp();
                }
                this.updateHUD();
            },

            levelUp() {
                this.player.level++;
                this.player.xp = 0;
                this.player.xpToNext = Math.floor(this.player.xpToNext * 1.5);
                
                console.log(`üéâ Level Up! Now level ${this.player.level}`);
                
                this.state.paused = true;
                this.showSkillSelection();
            },

            showSkillSelection() {
                const container = document.getElementById('skillsContainer');
                container.innerHTML = '';

                const availableSkills = Object.values(this.skillData).filter(skill => {
                    const currentTier = this.player.skills[skill.id] || 0;
                    return currentTier < skill.maxTier;
                });

                const selectedSkills = [];
                while (selectedSkills.length < 3 && availableSkills.length > 0) {
                    const randomIndex = Math.floor(Math.random() * availableSkills.length);
                    selectedSkills.push(availableSkills[randomIndex]);
                    availableSkills.splice(randomIndex, 1);
                }

                selectedSkills.forEach(skill => {
                    const currentTier = this.player.skills[skill.id] || 0;
                    const nextTier = currentTier + 1;

                    const card = document.createElement('div');
                    card.className = 'skill-card';
                    card.innerHTML = `
                        <div class="skill-icon">${skill.icon}</div>
                        <div class="skill-name">${skill.name}</div>
                        <div class="skill-description">${skill.description}<br><br>Tier ${nextTier}/${skill.maxTier}</div>
                    `;
                    card.onclick = () => this.selectSkill(skill, nextTier, card);
                    container.appendChild(card);
                });

                document.getElementById('skillScreen').classList.add('active');
            },

            selectSkill(skill, tier, cardElement) {
                document.querySelectorAll('.skill-card').forEach(c => c.classList.remove('selected'));
                cardElement.classList.add('selected');
                this.state.selectedSkill = { id: skill.id, tier: tier };
                document.getElementById('confirmSkill').disabled = false;
            },

            confirmSkill() {
                if (!this.state.selectedSkill) return;

                const id = this.state.selectedSkill.id;
                const tier = this.state.selectedSkill.tier;

                if (id === 'shield') {
                    this.player.hearts++;
                }
                if (id === 'support_fighters') {
                    this.initSupportFighters(tier);
                }
                if (id === 'laser_fortress') {
                    this.initLaserShips(tier);
                }

                this.player.skills[id] = tier;
                
                document.getElementById('skillScreen').classList.remove('active');
                this.state.paused = false;
                this.updateHUD();
            },

            initSupportFighters(tier) {
                this.supportFighters = [];
                this.supportFighters.push({
                    offsetX: -60,
                    offsetY: -20,
                    lastShot: 0
                });
                this.supportFighters.push({
                    offsetX: 60,
                    offsetY: -20,
                    lastShot: 0
                });
            },

            // FIXED: Initialize laser turrets with proper positioning
            initLaserShips(tier) {
                this.laserShips = [];
                if (tier === 1) {
                    // Level 1: 1 turret on left edge
                    this.laserShips.push({
                        x: 30,
                        y: 400,
                        active: false,
                        activationTime: 0,
                        tier: 1
                    });
                } else {
                    // Level 2: 2 turrets on right edge, remove left turret
                    this.laserShips.push({
                        x: this.canvas.width - 30,
                        y: 300,
                        active: false,
                        activationTime: 0,
                        tier: 2
                    });
                    this.laserShips.push({
                        x: this.canvas.width - 30,
                        y: 500,
                        active: false,
                        activationTime: 0,
                        tier: 2
                    });
                }
            },

            spawnBoss() {
                const bossTypes = Object.values(BOSSES);
                const selectedBoss = bossTypes[Math.floor(Math.random() * bossTypes.length)];
                
                // Boss HP scales moderately with time (every 180 seconds = 1 boss cycle adds 20% HP)
                const bossCount = Math.floor(this.state.gameTime / 180);
                const hpScaling = 1 + (bossCount * 0.2); // 20% increase per boss cycle
                
                this.boss = {
                    ...selectedBoss,
                    x: this.canvas.width / 2,
                    y: 200,
                    currentHp: Math.floor(selectedBoss.hp * hpScaling),
                    maxHp: Math.floor(selectedBoss.hp * hpScaling),
                    skillCooldowns: selectedBoss.skills.map(() => 0),
                    laserSweep: null,
                    spawnTime: Date.now()
                };
            },

            gameLoop() {
                if (!this.state.running) return;
                
                if (!this.state.paused) {
                    this.update();
                    this.state.gameTime += 1/60;
                }
                
                this.render();
                requestAnimationFrame(() => this.gameLoop());
            },

            update() {
                if (this.keys['ArrowLeft'] || this.keys['a']) this.player.x -= this.player.speed;
                if (this.keys['ArrowRight'] || this.keys['d']) this.player.x += this.player.speed;
                if (this.keys['ArrowUp'] || this.keys['w']) this.player.y -= this.player.speed;
                if (this.keys['ArrowDown'] || this.keys['s']) this.player.y += this.player.speed;
                
                this.player.x = Math.max(30, Math.min(this.canvas.width - 30, this.player.x));
                this.player.y = Math.max(30, Math.min(this.canvas.height - 30, this.player.y));

                const now = Date.now();
                const attackSpeed = this.player.attackSpeed + (this.player.skills.rapid || 0) * 2;
                if (now - this.player.lastShot > 1000 / attackSpeed) {
                    this.shoot();
                    this.player.lastShot = now;
                }

                // Support fighters
                if (this.player.skills.support_fighters) {
                    this.supportFighters.forEach(fighter => {
                        if (now - fighter.lastShot > 500) {
                            const fighterX = this.player.x + fighter.offsetX;
                            const fighterY = this.player.y + fighter.offsetY;
                            this.bullets.push({
                                x: fighterX,
                                y: fighterY - 20,
                                width: 6,
                                height: 15
                            });
                            fighter.lastShot = now;
                        }
                    });
                }

                // FIXED: Laser Fortress - Correct horizontal beam logic
                const laserTier = this.player.skills.laser_fortress || 0;
                if (laserTier > 0) {
                    const cooldown = laserTier === 1 ? 15000 : 10000;
                    const duration = 10000;

                    this.laserShips.forEach(ship => {
                        if (!ship.active && now - this.lastLaserActivation > cooldown) {
                            ship.active = true;
                            ship.activationTime = now;
                            this.lastLaserActivation = now;
                        }

                        if (ship.active && now - ship.activationTime > duration) {
                            ship.active = false;
                        }

                        if (ship.active) {
                            this.applyLaserDamage(ship, laserTier);
                        }
                    });
                }

                // Update boss
                if (this.boss) {
                    const bossTime = now - this.boss.spawnTime;
                    this.boss.movement(this.boss, this, bossTime);

                    // Boss skills
                    this.boss.skills.forEach((skill, idx) => {
                        if (now - this.boss.skillCooldowns[idx] > skill.cooldown) {
                            skill.execute(this.boss, this);
                            this.boss.skillCooldowns[idx] = now;
                        }
                    });

                    // Laser sweep for Cyber Skull
                    if (this.boss.laserSweep && this.boss.laserSweep.active) {
                        const elapsed = now - this.boss.laserSweep.startTime;
                        if (elapsed > this.boss.laserSweep.duration) {
                            this.boss.laserSweep.active = false;
                        } else {
                            this.boss.laserSweep.angle += 0.05;
                        }
                    }
                }

                // Update boss projectiles
                this.bossProjectiles.forEach((proj, idx) => {
                    if (proj.homing) {
                        const dx = this.player.x - proj.x;
                        const dy = this.player.y - proj.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        proj.vx += (dx / dist) * 0.2;
                        proj.vy += (dy / dist) * 0.2;
                        const speed = Math.sqrt(proj.vx * proj.vx + proj.vy * proj.vy);
                        if (speed > proj.speed) {
                            proj.vx = (proj.vx / speed) * proj.speed;
                            proj.vy = (proj.vy / speed) * proj.speed;
                        }
                    }

                    if (proj.ring) {
                        proj.radius += proj.expandSpeed;
                        if (proj.radius > proj.maxRadius) {
                            this.bossProjectiles.splice(idx, 1);
                            return;
                        }
                    } else {
                        proj.x += proj.vx;
                        proj.y += proj.vy;
                    }

                    // Check collision with player
                    if (proj.ring) {
                        const dist = Math.sqrt((this.player.x - proj.x) ** 2 + (this.player.y - proj.y) ** 2);
                        if (Math.abs(dist - proj.radius) < 20) {
                            this.player.hearts -= proj.damage;
                            this.updateHUD();
                            if (this.player.hearts <= 0) this.gameOver();
                        }
                    } else if (this.checkCollision(this.player, proj)) {
                        this.player.hearts -= proj.damage;
                        this.updateHUD();
                        this.bossProjectiles.splice(idx, 1);
                        if (this.player.hearts <= 0) this.gameOver();
                    }

                    if (proj.x < -50 || proj.x > this.canvas.width + 50 || proj.y < -50 || proj.y > this.canvas.height + 50) {
                        this.bossProjectiles.splice(idx, 1);
                    }
                });

                // Spawn asteroids (INCREASED SIZE)
                const baseSpawnRate = 0.008;
                const maxSpawnRate = 0.025;
                const spawnRateIncrease = Math.min(this.state.gameTime / 120, 1);
                const currentSpawnRate = baseSpawnRate + (maxSpawnRate - baseSpawnRate) * spawnRateIncrease;
                
                if (Math.random() < currentSpawnRate) {
                    this.spawnAsteroid();
                }

                // Boss spawning every 3 minutes (180 seconds)
                if (now - this.lastBossSpawn > 180000 && !this.boss) {
                    this.spawnBoss();
                    this.lastBossSpawn = now;
                }

                // Update bullets
                this.bullets = this.bullets.filter(b => {
                    b.y -= 15;
                    return b.y > -20;
                });

                // Update asteroids
                this.asteroids.forEach((a, i) => {
                    // Handle knockback phase
                    if (a.knockbackTime !== undefined) {
                        a.knockbackTime--;
                        if (a.knockbackTime <= 0) {
                            delete a.knockbackTime;
                            delete a.knockbackVx;
                            delete a.knockbackVy;
                        } else {
                            a.x += a.knockbackVx;
                            a.y += a.knockbackVy;
                        }
                    } else {
                        a.y += a.vy;
                        a.x += a.vx;
                    }
                    
                    a.rotation += a.rotSpeed;

                    if (a.x <= a.size/2 || a.x >= this.canvas.width - a.size/2) a.vx *= -1;

                    if (this.checkCollision(this.player, a)) {
                        this.player.hearts--;
                        this.updateHUD();
                        this.asteroids.splice(i, 1);
                        if (this.player.hearts <= 0) this.gameOver();
                    }

                    if (a.y > this.canvas.height + 50) this.asteroids.splice(i, 1);
                });

                // Bullet-asteroid collision
                this.bullets.forEach((b, bi) => {
                    this.asteroids.forEach((a, ai) => {
                        if (this.checkCollision(b, a)) {
                            a.hp -= this.player.damage;
                            if (a.hp <= 0) {
                                const rewards = this.getRewardsForAsteroid(a.tier);
                                this.destroyAsteroid(a, ai);
                                this.gainXP(10);
                                this.state.score += rewards.stars;
                                this.state.coins += rewards.coins;
                                this.updateHUD();
                            }
                            this.bullets.splice(bi, 1);
                        }
                    });
                });

                // Bullet-boss collision
                if (this.boss) {
                    this.bullets.forEach((b, bi) => {
                        if (this.checkCollision(b, this.boss)) {
                            this.boss.currentHp -= this.player.damage;
                            this.bullets.splice(bi, 1);
                            if (this.boss.currentHp <= 0) {
                                this.gainXP(500);
                                this.state.score += 1000;
                                this.state.coins += 50;
                                this.boss = null;
                                this.updateHUD();
                            }
                        }
                    });
                }
            },

            // FIXED: Laser damage applies to entities in horizontal beam path
            applyLaserDamage(ship, tier) {
                const damage = tier === 1 ? 5 : 7.5;
                const laserWidth = 20; // Beam width for collision detection
                
                // Determine laser direction based on ship position
                const isLeftSide = ship.x < this.canvas.width / 2;
                const startX = ship.x;
                const endX = isLeftSide ? this.canvas.width : 0;
                
                // Check asteroids in horizontal beam path
                this.asteroids.forEach((target, idx) => {
                    // Check if asteroid is in the horizontal beam path
                    const inHorizontalPath = Math.abs(target.y - ship.y) < laserWidth + target.size / 2;
                    const inCorrectDirection = isLeftSide ? target.x > ship.x : target.x < ship.x;
                    
                    if (inHorizontalPath && inCorrectDirection) {
                        // Check if any asteroid is blocking this one
                        const blocked = this.isLaserBlockedHorizontal(ship, target);
                        
                        if (!blocked && Math.random() < 0.05) {
                            target.hp -= damage;
                            if (target.hp <= 0) {
                                const rewards = this.getRewardsForAsteroid(target.tier);
                                this.destroyAsteroid(target, idx);
                                this.gainXP(10);
                                this.state.score += rewards.stars;
                                this.state.coins += rewards.coins;
                                this.updateHUD();
                            }
                        }
                    }
                });
                
                // Check boss in horizontal beam path
                if (this.boss) {
                    const inHorizontalPath = Math.abs(this.boss.y - ship.y) < laserWidth + this.boss.size / 2;
                    const inCorrectDirection = isLeftSide ? this.boss.x > ship.x : this.boss.x < ship.x;
                    
                    if (inHorizontalPath && inCorrectDirection) {
                        const blocked = this.isLaserBlockedHorizontal(ship, this.boss);
                        
                        if (!blocked && Math.random() < 0.05) {
                            this.boss.currentHp -= damage;
                            if (this.boss.currentHp <= 0) {
                                this.gainXP(500);
                                this.state.score += 1000;
                                this.state.coins += 50;
                                this.boss = null;
                                this.updateHUD();
                            }
                        }
                    }
                }
            },

            // FIXED: Check if laser beam is blocked by asteroids in horizontal path
            isLaserBlockedHorizontal(ship, targetEntity) {
                const isLeftSide = ship.x < this.canvas.width / 2;
                const laserWidth = 20;
                
                for (let entity of this.asteroids) {
                    if (entity === targetEntity) continue;
                    
                    // Check if this entity is between the ship and target
                    const isBetween = isLeftSide ? 
                        (entity.x > ship.x && entity.x < targetEntity.x) :
                        (entity.x < ship.x && entity.x > targetEntity.x);
                    
                    if (isBetween) {
                        // Check if entity is in the beam path
                        const inPath = Math.abs(entity.y - ship.y) < laserWidth + entity.size / 2;
                        if (inPath) return true;
                    }
                }
                
                // Check if boss blocks
                if (this.boss && this.boss !== targetEntity) {
                    const isBetween = isLeftSide ? 
                        (this.boss.x > ship.x && this.boss.x < targetEntity.x) :
                        (this.boss.x < ship.x && this.boss.x > targetEntity.x);
                    
                    if (isBetween) {
                        const inPath = Math.abs(this.boss.y - ship.y) < laserWidth + this.boss.size / 2;
                        if (inPath) return true;
                    }
                }
                
                return false;
            },

            getRewardsForAsteroid(tier) {
                const rewards = {
                    'veryLarge': { stars: 50, coins: 5 },
                    'large': { stars: 25, coins: 3 },
                    'medium': { stars: 15, coins: 2 },
                    'small': { stars: 10, coins: 1 }
                };
                return rewards[tier] || { stars: 10, coins: 1 };
            },

            shoot() {
                const streams = this.player.skills.multishot ? 
                    (this.player.skills.multishot === 1 ? 2 : 3) : 1;
                
                const spread = 25;
                for (let i = 0; i < streams; i++) {
                    const offset = (i - (streams - 1) / 2) * spread;
                    this.bullets.push({
                        x: this.player.x + offset,
                        y: this.player.y - 30,
                        width: 8,
                        height: 20
                    });
                }
            },

            spawnAsteroid() {
                const tierWeights = [
                    { tier: 'veryLarge', weight: 0.3 },
                    { tier: 'large', weight: 0.35 },
                    { tier: 'medium', weight: 0.25 },
                    { tier: 'small', weight: 0.1 }
                ];

                let rand = Math.random();
                let selectedTier = 'medium';
                let cumulative = 0;
                
                for (const tw of tierWeights) {
                    cumulative += tw.weight;
                    if (rand <= cumulative) {
                        selectedTier = tw.tier;
                        break;
                    }
                }

                const size = this.getSizeForTier(selectedTier);
                const hp = this.getHPForTier(selectedTier);
                
                const colors = [
                    '#00ffff', '#ff00ff', '#00ff00', '#ff8800',
                    '#8800ff', '#ffff00', '#ff0088', '#00ff88'
                ];

                this.asteroids.push({
                    x: Math.random() * this.canvas.width,
                    y: -100,
                    size: size,
                    hp: hp,
                    tier: selectedTier,
                    vx: (Math.random() - 0.5) * 2,
                    vy: 1 + Math.random() * 2,
                    rotation: 0,
                    rotSpeed: (Math.random() - 0.5) * 0.05,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    vertices: this.generatePolygon(size)
                });
            },

            destroyAsteroid(asteroid, index) {
                this.asteroids.splice(index, 1);

                if (asteroid.tier !== 'small') {
                    const nextTier = this.getNextTier(asteroid.tier);
                    const nextSize = this.getSizeForTier(nextTier);
                    const nextHP = this.getHPForTier(nextTier);

                    for (let i = 0; i < 2; i++) {
                        const horizontalDirection = (i === 0 ? -1 : 1);
                        const horizontalSpeed = 2 + Math.random() * 1.5;
                        
                        const baseDownwardVelocity = Math.max(asteroid.vy, 1.5);
                        const downwardSpeed = baseDownwardVelocity + Math.random() * 0.5;

                        const knockbackDistance = 15;
                        const knockbackFrames = 5;
                        
                        const knockbackVx = horizontalDirection * (knockbackDistance / knockbackFrames);
                        const knockbackVy = -2;

                        const newAsteroid = {
                            x: asteroid.x + horizontalDirection * 20,
                            y: asteroid.y,
                            size: nextSize,
                            hp: nextHP,
                            tier: nextTier,
                            vx: horizontalDirection * horizontalSpeed,
                            vy: downwardSpeed,
                            rotation: Math.random() * Math.PI * 2,
                            rotSpeed: (Math.random() - 0.5) * 0.08,
                            color: asteroid.color,
                            vertices: this.generatePolygon(nextSize),
                            knockbackTime: knockbackFrames,
                            knockbackVx: knockbackVx,
                            knockbackVy: knockbackVy
                        };

                        this.asteroids.push(newAsteroid);
                    }
                }
            },

            getNextTier(currentTier) {
                const tiers = {
                    'veryLarge': 'large',
                    'large': 'medium',
                    'medium': 'small',
                    'small': null
                };
                return tiers[currentTier];
            },

            getSizeForTier(tier) {
                const sizes = {
                    'veryLarge': 120,
                    'large': 85,
                    'medium': 55,
                    'small': 30
                };
                return sizes[tier];
            },

            getHPForTier(tier) {
                const hps = {
                    'veryLarge': 80,
                    'large': 40,
                    'medium': 20,
                    'small': 10
                };
                return hps[tier];
            },

            generatePolygon(size) {
                const vertices = [];
                const count = 6 + Math.floor(Math.random() * 3);
                for (let i = 0; i < count; i++) {
                    const angle = (i / count) * Math.PI * 2;
                    const radius = size / 2 * (0.8 + Math.random() * 0.4);
                    vertices.push({
                        x: Math.cos(angle) * radius,
                        y: Math.sin(angle) * radius
                    });
                }
                return vertices;
            },

            checkCollision(a, b) {
                const r1 = a.width ? Math.max(a.width, a.height) / 2 : a.size / 2;
                const r2 = b.width ? Math.max(b.width, b.height) / 2 : b.size / 2;
                const dist = Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2);
                return dist < r1 + r2;
            },

            render() {
                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                this.renderParallaxStars();

                // FIXED: Render laser beams as straight horizontal lines
                this.laserShips.forEach(ship => {
                    if (ship.active) {
                        const isLeftSide = ship.x < this.canvas.width / 2;
                        const endX = isLeftSide ? this.canvas.width : 0;
                        
                        // Draw white border
                        this.ctx.strokeStyle = '#ffffff';
                        this.ctx.lineWidth = 19;
                        this.ctx.globalAlpha = 0.8;
                        this.ctx.beginPath();
                        this.ctx.moveTo(ship.x, ship.y);
                        this.ctx.lineTo(endX, ship.y);
                        this.ctx.stroke();
                        
                        // Draw red core
                        this.ctx.strokeStyle = '#ff0000';
                        this.ctx.lineWidth = 15;
                        this.ctx.globalAlpha = 0.9;
                        this.ctx.shadowBlur = 20;
                        this.ctx.shadowColor = '#ff0000';
                        this.ctx.beginPath();
                        this.ctx.moveTo(ship.x, ship.y);
                        this.ctx.lineTo(endX, ship.y);
                        this.ctx.stroke();
                        this.ctx.shadowBlur = 0;
                        
                        this.ctx.globalAlpha = 1;
                        
                        // NEW: Draw turret (or image if available)
                        const imageKey = ship.tier === 1 ? 'laserTurret1' : 'laserTurret2';
                        if (IMAGES[imageKey] && IMAGES[imageKey].complete) {
                            this.ctx.drawImage(IMAGES[imageKey], ship.x - 20, ship.y - 20, 40, 40);
                        } else {
                            this.ctx.fillStyle = '#666';
                            this.ctx.fillRect(ship.x - 20, ship.y - 20, 40, 40);
                        }
                    }
                });

                // Render boss laser sweep
                if (this.boss && this.boss.laserSweep && this.boss.laserSweep.active) {
                    const angle = this.boss.laserSweep.angle;
                    this.ctx.strokeStyle = '#00ffff';
                    this.ctx.lineWidth = 10;
                    this.ctx.shadowBlur = 20;
                    this.ctx.shadowColor = '#00ffff';
                    this.ctx.beginPath();
                    this.ctx.moveTo(this.boss.x, this.boss.y);
                    this.ctx.lineTo(
                        this.boss.x + Math.cos(angle) * 1000,
                        this.boss.y + Math.sin(angle) * 1000
                    );
                    this.ctx.stroke();
                    this.ctx.shadowBlur = 0;
                }

                // Render boss projectiles
                this.bossProjectiles.forEach(proj => {
                    if (proj.ring) {
                        this.ctx.strokeStyle = proj.color;
                        this.ctx.lineWidth = 5;
                        this.ctx.shadowBlur = 15;
                        this.ctx.shadowColor = proj.color;
                        this.ctx.beginPath();
                        this.ctx.arc(proj.x, proj.y, proj.radius, 0, Math.PI * 2);
                        this.ctx.stroke();
                        this.ctx.shadowBlur = 0;
                    } else {
                        this.ctx.fillStyle = proj.color;
                        this.ctx.shadowBlur = 15;
                        this.ctx.shadowColor = proj.color;
                        this.ctx.beginPath();
                        this.ctx.arc(proj.x, proj.y, proj.size, 0, Math.PI * 2);
                        this.ctx.fill();
                        this.ctx.shadowBlur = 0;
                    }
                });

                // NEW: Render boss (with image support)
                if (this.boss) {
                    this.ctx.save();
                    this.ctx.translate(this.boss.x, this.boss.y);
                    
                    // Check if custom image is available
                    if (IMAGES[this.boss.imageKey] && IMAGES[this.boss.imageKey].complete) {
                        const imgSize = this.boss.size * 2;
                        this.ctx.drawImage(IMAGES[this.boss.imageKey], -imgSize/2, -imgSize/2, imgSize, imgSize);
                    } else {
                        // Draw boss based on type (default visuals)
                        if (this.boss.id === 'flame_demon') {
                            this.ctx.fillStyle = this.boss.color;
                            this.ctx.shadowBlur = 30;
                            this.ctx.shadowColor = this.boss.color;
                            this.ctx.beginPath();
                            this.ctx.arc(0, -20, 50, 0, Math.PI * 2);
                            this.ctx.fill();
                            this.ctx.fillRect(-30, 10, 60, 40);
                            
                            this.ctx.fillStyle = '#000';
                            this.ctx.beginPath();
                            this.ctx.arc(-20, -20, 10, 0, Math.PI * 2);
                            this.ctx.arc(20, -20, 10, 0, Math.PI * 2);
                            this.ctx.fill();
                        } else if (this.boss.id === 'void_kraken') {
                            this.ctx.fillStyle = this.boss.color;
                            this.ctx.shadowBlur = 30;
                            this.ctx.shadowColor = this.boss.color;
                            this.ctx.beginPath();
                            this.ctx.arc(0, 0, 60, 0, Math.PI * 2);
                            this.ctx.fill();
                            
                            for (let i = 0; i < 6; i++) {
                                const angle = (i / 6) * Math.PI * 2;
                                this.ctx.beginPath();
                                this.ctx.moveTo(0, 0);
                                this.ctx.lineTo(Math.cos(angle) * 80, Math.sin(angle) * 80);
                                this.ctx.lineWidth = 15;
                                this.ctx.strokeStyle = this.boss.color;
                                this.ctx.stroke();
                            }
                        } else if (this.boss.id === 'cyber_skull') {
                            this.ctx.strokeStyle = this.boss.color;
                            this.ctx.fillStyle = this.boss.color + '44';
                            this.ctx.lineWidth = 4;
                            this.ctx.shadowBlur = 30;
                            this.ctx.shadowColor = this.boss.color;
                            
                            this.ctx.beginPath();
                            for (let i = 0; i < 6; i++) {
                                const angle = (i / 6) * Math.PI * 2;
                                const x = Math.cos(angle) * 60;
                                const y = Math.sin(angle) * 60;
                                if (i === 0) this.ctx.moveTo(x, y);
                                else this.ctx.lineTo(x, y);
                            }
                            this.ctx.closePath();
                            this.ctx.fill();
                            this.ctx.stroke();
                            
                            this.ctx.beginPath();
                            this.ctx.arc(0, 0, 30, 0, Math.PI * 2);
                            this.ctx.stroke();
                        }
                    }
                    
                    this.ctx.shadowBlur = 0;
                    this.ctx.restore();
                    
                    // HP bar
                    const barWidth = 150;
                    const barHeight = 10;
                    const hpPercent = this.boss.currentHp / this.boss.maxHp;
                    
                    this.ctx.fillStyle = '#333';
                    this.ctx.fillRect(this.boss.x - barWidth/2, this.boss.y - this.boss.size - 20, barWidth, barHeight);
                    this.ctx.fillStyle = '#ff0000';
                    this.ctx.fillRect(this.boss.x - barWidth/2, this.boss.y - this.boss.size - 20, barWidth * hpPercent, barHeight);
                    this.ctx.strokeStyle = '#fff';
                    this.ctx.lineWidth = 2;
                    this.ctx.strokeRect(this.boss.x - barWidth/2, this.boss.y - this.boss.size - 20, barWidth, barHeight);
                    
                    // Boss name
                    this.ctx.fillStyle = '#fff';
                    this.ctx.font = 'bold 16px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(this.boss.name, this.boss.x, this.boss.y - this.boss.size - 35);
                }

                // Render asteroids
                this.asteroids.forEach(a => {
                    this.ctx.save();
                    this.ctx.translate(a.x, a.y);
                    this.ctx.rotate(a.rotation);
                    this.ctx.beginPath();
                    a.vertices.forEach((v, i) => {
                        if (i === 0) this.ctx.moveTo(v.x, v.y);
                        else this.ctx.lineTo(v.x, v.y);
                    });
                    this.ctx.closePath();
                    this.ctx.fillStyle = a.color + '33';
                    this.ctx.fill();
                    this.ctx.strokeStyle = a.color;
                    this.ctx.lineWidth = 4;
                    this.ctx.shadowBlur = 20;
                    this.ctx.shadowColor = a.color;
                    this.ctx.stroke();
                    this.ctx.shadowBlur = 0;
                    this.ctx.restore();

                    this.ctx.fillStyle = '#fff';
                    this.ctx.font = `bold ${a.size * 0.3}px Arial`;
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillText(Math.ceil(a.hp), a.x, a.y);
                });

                // NEW: Render player (with image support)
                if (IMAGES['player'] && IMAGES['player'].complete) {
                    this.ctx.drawImage(IMAGES['player'], 
                        this.player.x - this.player.width/2, 
                        this.player.y - this.player.height/2, 
                        this.player.width, 
                        this.player.height);
                } else {
                    this.ctx.save();
                    this.ctx.translate(this.player.x, this.player.y);
                    this.ctx.fillStyle = '#fff';
                    this.ctx.shadowBlur = 15;
                    this.ctx.shadowColor = '#00ffff';
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, -30);
                    this.ctx.lineTo(-20, 30);
                    this.ctx.lineTo(0, 20);
                    this.ctx.lineTo(20, 30);
                    this.ctx.closePath();
                    this.ctx.fill();
                    this.ctx.shadowBlur = 0;
                    this.ctx.restore();
                }

                // NEW: Render support fighters (with image support)
                this.supportFighters.forEach(fighter => {
                    const fighterX = this.player.x + fighter.offsetX;
                    const fighterY = this.player.y + fighter.offsetY;
                    
                    if (IMAGES['supportFighter'] && IMAGES['supportFighter'].complete) {
                        this.ctx.drawImage(IMAGES['supportFighter'], fighterX - 15, fighterY - 15, 30, 30);
                    } else {
                        this.ctx.save();
                        this.ctx.translate(fighterX, fighterY);
                        this.ctx.fillStyle = '#00ff00';
                        this.ctx.shadowBlur = 10;
                        this.ctx.shadowColor = '#00ff00';
                        this.ctx.beginPath();
                        this.ctx.moveTo(0, -15);
                        this.ctx.lineTo(-10, 15);
                        this.ctx.lineTo(0, 10);
                        this.ctx.lineTo(10, 15);
                        this.ctx.closePath();
                        this.ctx.fill();
                        this.ctx.shadowBlur = 0;
                        this.ctx.restore();
                    }
                });

                // Render bullets
                this.bullets.forEach(b => {
                    this.ctx.fillStyle = '#00ff00';
                    this.ctx.shadowBlur = 10;
                    this.ctx.shadowColor = '#00ff00';
                    this.ctx.fillRect(b.x - 4, b.y - 10, 8, 20);
                    this.ctx.shadowBlur = 0;
                });
            },

            renderParallaxStars() {
                this.starLayers.forEach(layer => {
                    this.ctx.fillStyle = `rgba(255, 255, 255, ${layer.opacity})`;
                    
                    layer.stars.forEach(star => {
                        star.y += layer.speed;
                        
                        if (star.y > this.canvas.height) {
                            star.y = 0;
                            star.x = Math.random() * this.canvas.width;
                        }
                        
                        this.ctx.fillRect(star.x, star.y, layer.size, layer.size);
                    });
                });
            },

            gameOver() {
                console.log('üíÄ Game Over');
                this.state.running = false;
                document.getElementById('touchLayer').classList.remove('active');
                document.getElementById('pauseBtn').classList.remove('active');
                document.getElementById('finalScore').textContent = this.state.score;
                document.getElementById('gameOverScreen').classList.add('active');
            },

            restart() {
                document.getElementById('gameOverScreen').classList.remove('active');
                this.startGame();
            },

            backToMenu() {
                document.getElementById('gameOverScreen').classList.remove('active');
                this.showMainMenu();
            }
        };

        console.log('üöÄ Meteor Smash - Initializing...');
        game.init();
    </script>
</body>
</html>